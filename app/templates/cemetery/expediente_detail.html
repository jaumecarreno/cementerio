{% extends "base.html" %}
{% set active_cem = 'expedientes' %}
{% set breadcrumbs = [
  {'label': t('menu.cemetery'), 'href': url_for('cemetery.panel')},
  {'label': t('cases.title'), 'href': url_for('cemetery.expedientes')},
  {'label': expediente.numero, 'href': None}
] %}
{% block title %}{{ t('cases.title') }} · {{ expediente.numero }}{% endblock %}
{% block content %}
<h1 class="page-title">{{ t('cases.title') }} · {{ expediente.numero }}</h1>

<div class="box">
  <h3>{{ t('common.summary') }}</h3>
  <div class="meta-row">
    <div><strong>{{ t('field.type') }}:</strong> {{ expediente.tipo }}</div>
    <div><strong>{{ t('field.status') }}:</strong> {{ expediente.estado }}</div>
    <div><strong>{{ t('cem.graves') }}:</strong> {{ expediente.sepultura_id or '-' }}</div>
    <div><strong>{{ t('field.deceased') }}:</strong> {{ expediente.difunto.full_name if expediente.difunto else '-' }}</div>
    <div><strong>{{ t('field.declarant') }}:</strong> {{ expediente.declarante.full_name if expediente.declarante else '-' }}</div>
    <div><strong>{{ t('field.expected_date') }}:</strong> {{ expediente.fecha_prevista or '-' }}</div>
  </div>
  <div><strong>{{ t('field.notes') }}:</strong> {{ expediente.notas or '-' }}</div>
</div>

<div class="box">
  <h3>{{ t('field.status') }}</h3>
  <form class="inline-form" method="post" action="{{ url_for('cemetery.expediente_change_state', expediente_id=expediente.id) }}">
    <select name="estado" required>
      {% for st in states %}
      <option value="{{ st }}" {% if expediente.estado == st %}selected{% endif %}>{{ st }}</option>
      {% endfor %}
    </select>
    <button class="btn" type="submit">{{ t('common.update_status') }}</button>
  </form>
</div>

<div class="box">
  <h3>{{ t('common.work_orders') }}</h3>
  <form method="post" action="{{ url_for('cemetery.expediente_create_ot', expediente_id=expediente.id) }}">
    <div class="form-grid">
      <div>
        <label>{{ t('common.title') }}</label>
        <input type="text" name="titulo" placeholder="{{ t('cases.inhumation') }}">
      </div>
      <div>
        <label>{{ t('field.notes') }}</label>
        <input type="text" name="notes" placeholder="Indicaciones de trabajo">
      </div>
    </div>
    <div class="actions-row">
      <button class="btn primary" type="submit">{{ t('common.create') }} OT</button>
    </div>
  </form>

  <table>
    <thead>
      <tr>
        <th>OT</th>
        <th>{{ t('common.title') }}</th>
        <th>Estado</th>
        <th>Completada</th>
        <th>{{ t('common.actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for ot in ots %}
      <tr>
        <td>#{{ ot.id }}</td>
        <td>{{ ot.titulo }}</td>
        <td>{{ ot.estado }}</td>
        <td>{{ ot.completed_at or '-' }}</td>
        <td>
          <a class="btn" href="{{ url_for('cemetery.expediente_ot_order_pdf', expediente_id=expediente.id, ot_id=ot.id) }}" target="_blank">PDF</a>
          {% if ot.estado != 'COMPLETADA' %}
          <form class="inline-form" method="post" action="{{ url_for('cemetery.expediente_complete_ot', expediente_id=expediente.id, ot_id=ot.id) }}">
            <input type="text" name="notes" placeholder="Notas cierre">
            <button class="btn" type="submit">{{ t('common.complete') }}</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="5">{{ t('common.no_results') }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
