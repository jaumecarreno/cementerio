<!-- Spec 9.1.3 + 5.3.4 - Cobro de tasas de mantenimiento -->
{% extends "base.html" %}
{% set active_cem = 'tasas' %}
{% block title %}{{ t('fees.collection_title') }}{% endblock %}
{% block content %}
<h1 class="page-title">{{ t('fees.collection_title') }}</h1>

<div class="box">
  <div class="meta-row">
    <div><strong>{{ t('field.grave') }}:</strong> {{ data.sepultura.location_label }}</div>
    {% if data.titularidad %}
    <div>
      <strong>{{ t('cem.ownership') }}:</strong> {{ data.titularidad.person.full_name }}
      {% if data.titularidad.pensionista %}
      (Pensionista: Si)
      {% endif %}
    </div>
    {% endif %}
    <div class="muted"><strong>Regla:</strong> no cobrar anos nuevos con anos antiguos pendientes.</div>
  </div>
</div>

{% if not data.beneficiario and data.contrato %}
<div class="warning">
  <p><strong>Atención:</strong> la sepultura no tiene beneficiario.</p>
  <form method="post" action="{{ url_for('cemetery.nominate_beneficiary', contract_id=data.contrato.id) }}">
    <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
    {% with
      picker_id='fees-beneficiario-' ~ data.sepultura.id,
      field_name='person_id',
      label='Beneficiario',
      selected_person=None,
      required=True
    %}
      {% include "components/person_picker.html" %}
    {% endwith %}
    <div class="actions-row">
      <button class="btn" type="submit">Asignar beneficiario</button>
    </div>
  </form>
</div>
{% endif %}

<form method="post" id="fees-form">
  <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
  <div class="split">
    <div class="box">
      <h3>Tiques no facturados (pendientes)</h3>
      <table>
        <thead>
          <tr>
            <th>Sel.</th>
            <th>Año</th>
            <th>Importe</th>
            <th>Descuento</th>
            <th>Aplicar desc.</th>
            <th>Estado</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody>
          {% for ticket in data.pending_tickets %}
          {% set can_toggle_discount = data.titularidad and data.titularidad.pensionista and data.titularidad.pensionista_desde and ticket.anio < data.titularidad.pensionista_desde.year %}
          {% set auto_discount = data.titularidad and data.titularidad.pensionista and data.titularidad.pensionista_desde and ticket.anio >= data.titularidad.pensionista_desde.year %}
          <tr>
            <td><input class="ticket-checkbox" type="checkbox" name="ticket_ids" value="{{ ticket.id }}" data-year="{{ ticket.anio }}"></td>
            <td>{{ ticket.anio }}</td>
            <td>{{ money(ticket.importe) }}</td>
            <td>{{ ticket.descuento_tipo.value }}</td>
            <td>
              {% if can_toggle_discount %}
              <input type="checkbox" name="discount_ticket_ids" value="{{ ticket.id }}">
              {% elif auto_discount %}
              Auto
              {% else %}
              -
              {% endif %}
            </td>
            <td>{{ ticket.estado.value }}</td>
            <td>No facturado</td>
          </tr>
          {% else %}
          <tr><td colspan="7">Sin tiques pendientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="box">
      <h3>Facturas impagadas</h3>
      <table>
        <thead>
          <tr>
            <th>Factura</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in data.unpaid_invoices %}
          <tr>
            <td>{{ invoice.numero }}</td>
            <td>{{ invoice.issued_at.date() if invoice.issued_at else '-' }}</td>
            <td>{{ money(invoice.total_amount) }}</td>
            <td>{{ invoice.estado.value }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4">Sin facturas impagadas.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="box">
    <div class="meta-row">
      <div><strong>Total pendiente:</strong> {{ money(data.total_pending) }}</div>
      <div>
        <label>{{ t('field.payment_method') }}</label>
        <select name="payment_method">
          <option value="EFECTIVO">Efectivo</option>
          <option value="TARJETA">Tarjeta</option>
        </select>
      </div>
    </div>
    <div class="actions-row">
      <button class="btn primary" type="submit" formaction="{{ url_for('cemetery.fee_collect_and_receipt') }}">Cobrar y emitir recibo</button>
    </div>
  </div>
</form>

<script>
  (function () {
    const checkboxes = Array.from(document.querySelectorAll(".ticket-checkbox"));
    function enforceOrder() {
      let firstGapFound = false;
      checkboxes.forEach((cb) => {
        if (firstGapFound) {
          cb.disabled = !cb.checked;
          return;
        }
        cb.disabled = false;
        if (!cb.checked) {
          firstGapFound = true;
        }
      });
    }
    checkboxes.forEach((cb) => cb.addEventListener("change", enforceOrder));
    enforceOrder();
  })();
</script>
{% endblock %}
