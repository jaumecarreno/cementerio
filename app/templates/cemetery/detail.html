<!-- Spec 9.4.3 / 9.4.4 / 9.4.5 / 9.1.7 - Ficha de sepultura -->
{% extends "base.html" %}
{% set active_cem = 'sepulturas' %}
{% block title %}{{ t('field.grave') }} {{ data.sepultura.location_label }}{% endblock %}
{% block content %}
{% macro detail_field(label, value) -%}
<div class="detail-field">
  <span class="detail-field-label">{{ label }}</span>
  <span class="detail-field-value">{{ value if value else '-' }}</span>
</div>
{%- endmacro %}

<h1 class="page-title">{{ t('field.grave') }} {{ data.sepultura.location_label }}</h1>

<div class="box">
  <div class="meta-row">
    <div><strong>Modalidad:</strong> {{ data.sepultura.modalidad }}</div>
    <div><strong>Estado:</strong> {{ data.sepultura.estado.value }}</div>
    {% if data.contrato %}
    <div>
      <strong>Contrato:</strong>
      {{ 'LLOGUER' if data.contrato.tipo.value == 'USO_INMEDIATO' else data.contrato.tipo.value }}
      ({{ data.contrato.fecha_inicio }} - {{ data.contrato.fecha_fin }})
    </div>
    {% endif %}
  </div>
  {% if data.tab != 'principal' %}
  <div class="quick-actions">
    <form class="inline-form" method="post" action="{{ url_for('cemetery.change_state', sepultura_id=data.sepultura.id) }}">
      <select name="estado">
        <option value="LLIURE">LLIURE</option>
        <option value="DISPONIBLE">DISPONIBLE</option>
        <option value="INACTIVA">INACTIVA</option>
        <option value="PROPIA">PROPIA</option>
      </select>
      <button type="submit">Cambiar estado</button>
    </form>
    <a class="btn" href="{{ url_for('cemetery.fee_collection', sepultura_id=data.sepultura.id) }}">Cobrar tasas</a>
    {% if not data.contrato %}
    <a class="btn" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='derecho') }}">Crear derecho funerario</a>
    {% endif %}
    <a class="btn" href="{{ url_for('cemetery.expedientes', sepultura_id=data.sepultura.id) }}">Nuevo exp.</a>
    <a class="btn" href="{{ url_for('cemetery.ownership_cases') }}">{{ t('cem.ownership') }}</a>
    <a class="btn" href="{{ url_for('cemetery.lapidas', sepultura_id=data.sepultura.id) }}">Lápidas</a>
  </div>
  {% endif %}
</div>

<div class="cem-submenu">
  <a class="tab-link {% if data.tab == 'principal' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='principal') }}">Principal</a>
  <a class="tab-link {% if data.tab == 'resumen' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='resumen') }}">Resumen</a>
  <a class="tab-link {% if data.tab == 'titularidad' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='titularidad') }}">Titularidad</a>
  <a class="tab-link {% if data.tab == 'titulares' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='titulares') }}">Titulares</a>
  <a class="tab-link {% if data.tab == 'beneficiarios' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='beneficiarios') }}">Beneficiarios</a>
  <a class="tab-link {% if data.tab == 'difuntos' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='difuntos') }}">Difuntos</a>
  <a class="tab-link {% if data.tab == 'movimientos' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='movimientos') }}">Movimientos</a>
  <a class="tab-link {% if data.tab == 'tasas' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='tasas') }}">Tasas</a>
  <a class="tab-link {% if data.tab == 'derecho' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='derecho') }}">{{ t('cem.rights') }}</a>
  <a class="tab-link {% if data.tab == 'lapidas' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='lapidas') }}">{{ t('cem.engraving') }}</a>
</div>

{% if data.tab == 'principal' %}
{% set titular_person = data.active_titular.person if data.active_titular else none %}
{% set beneficiario_person = data.active_beneficiario.person if data.active_beneficiario else none %}
{% set representante_person = data.representante %}
<section class="detail-cards">
  <div class="box detail-card">
    <div class="detail-card-head">
      <h3>Titular</h3>
      <form method="post" action="{{ url_for('cemetery.change_holder_direct', sepultura_id=data.sepultura.id) }}">
        <button class="btn primary" type="submit">Cambiar titular</button>
      </form>
    </div>
    <div class="detail-card-grid">
      {{ detail_field('Nombre', titular_person.full_name if titular_person else '-') }}
      {{ detail_field('Telefono', titular_person.telefono if titular_person else '-') }}
      {{ detail_field('Email', titular_person.email if titular_person else '-') }}
      {{ detail_field('DNI/NIF', titular_person.dni_nif if titular_person else '-') }}
      {{ detail_field('Direccion', titular_person.direccion if titular_person else '-') }}
      <div class="detail-field">
        <span class="detail-field-label">Estado pensionista</span>
        <span class="detail-field-value">
          <label class="detail-checkbox">
            <input type="checkbox" disabled {% if data.active_titular and data.active_titular.is_pensioner %}checked{% endif %}>
            <span>Pensionista</span>
          </label>
          {% if data.active_titular and data.active_titular.is_pensioner %}
          <span class="pensionista-badge">Pensionista</span>
          {% endif %}
        </span>
      </div>
    </div>
  </div>

  <div class="box detail-card">
    <h3>Beneficiario</h3>
    <div class="detail-card-grid">
      {{ detail_field('Nombre', beneficiario_person.full_name if beneficiario_person else '-') }}
      {{ detail_field('Telefono', beneficiario_person.telefono if beneficiario_person else '-') }}
      {{ detail_field('Email', beneficiario_person.email if beneficiario_person else '-') }}
      {{ detail_field('DNI/NIF', beneficiario_person.dni_nif if beneficiario_person else '-') }}
      {{ detail_field('Direccion', beneficiario_person.direccion if beneficiario_person else '-') }}
    </div>
  </div>

  <div class="box detail-card">
    <h3>Representante</h3>
    <div class="detail-card-grid">
      {{ detail_field('Nombre', representante_person.full_name if representante_person else '-') }}
      {{ detail_field('Telefono', representante_person.telefono if representante_person else '-') }}
      {{ detail_field('Email', representante_person.email if representante_person else '-') }}
      {{ detail_field('DNI/NIF', representante_person.dni_nif if representante_person else '-') }}
      {{ detail_field('Direccion', representante_person.direccion if representante_person else '-') }}
    </div>
  </div>

  <div class="box detail-card">
    <h3>Difuntos</h3>
    <table class="table-zebra">
      <thead>
        <tr>
          <th>Persona</th>
          <th>Fecha alta</th>
          <th>Notas</th>
        </tr>
      </thead>
      <tbody>
        {% for d_item in data.difuntos %}
        <tr>
          <td>{{ d_item.person.full_name }}</td>
          <td>{{ d_item.created_at.date() }}</td>
          <td>{{ d_item.notes or '-' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3">Sin difuntos</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="box detail-card">
    <h3>Tasas</h3>
    <table class="table-zebra">
      <thead>
        <tr>
          <th>Año</th>
          <th>Estado</th>
          <th>Importe</th>
        </tr>
      </thead>
      <tbody>
        {% for ticket in data.tasas %}
        <tr>
          <td>{{ ticket.anio }}</td>
          <td>{{ ticket.estado.value }}</td>
          <td>{{ money(ticket.importe) }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3">Sin tasas</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="box detail-card">
    <h3>{{ t('cem.rights') }}</h3>
    {% if data.contrato %}
    <div class="detail-card-grid">
      {{ detail_field('Tipo de concesión', 'LLOGUER' if data.contrato.tipo.value == 'USO_INMEDIATO' else data.contrato.tipo.value) }}
      {{ detail_field('Inicio', data.contrato.fecha_inicio) }}
      {{ detail_field('Fin', data.contrato.fecha_fin) }}
      {{ detail_field('Importe anual base', money(data.contrato.annual_fee_amount)) }}
    </div>
    <div class="actions-row">
      <a class="btn primary" href="{{ url_for('cemetery.contract_title_pdf', contract_id=data.contrato.id) }}" target="_blank">Descargar título (PDF)</a>
      <a class="btn" href="{{ url_for('module_pending', slug='ampliacion-derecho') }}">Ampliación</a>
      <a class="btn" href="{{ url_for('module_pending', slug='prorroga-derecho') }}">Prórroga</a>
    </div>
    {% else %}
    <p>No hay contrato activo asociado a esta sepultura.</p>
    {% endif %}
  </div>

  <div class="box detail-card">
    <h3>Características de la sepultura</h3>
    <div class="detail-card-grid">
      {{ detail_field('Ubicación', data.sepultura.location_label) }}
      {{ detail_field('Via', data.sepultura.via) }}
      {{ detail_field('Tipo bloque', data.sepultura.tipo_bloque) }}
      {{ detail_field('Tipo lapida', data.sepultura.tipo_lapida) }}
      {{ detail_field('Orientacion', data.sepultura.orientacion) }}
      {{ detail_field('Difuntos registrados', data.difuntos_count) }}
    </div>
  </div>

  <div class="box detail-card">
    <h3>Lápidas / inscripciones</h3>
    <table class="table-zebra">
      <thead>
        <tr>
          <th>Texto</th>
          <th>Estado</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        {% for inscripcion in data.inscripciones %}
        <tr>
          <td>{{ inscripcion.texto }}</td>
          <td>{{ inscripcion.estado }}</td>
          <td>{{ inscripcion.created_at.date() }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3">Sin inscripciones</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="box detail-card">
    <h3>Movimientos</h3>
    <table class="table-zebra">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Detalle</th>
          <th>Usuario</th>
        </tr>
      </thead>
      <tbody>
        {% for mov in data.movimientos %}
        <tr>
          <td>{{ mov.fecha.date() }}</td>
          <td>{{ mov.tipo.value }}</td>
          <td>{{ mov.detalle }}</td>
          <td>{{ mov.user.full_name if mov.user else 'sistema' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="4">{{ t('common.no_results') }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% elif data.tab == 'resumen' %}
<div class="box">
  <h3>{{ t('common.summary') }}</h3>
  <p>Ubicacion: {{ data.sepultura.location_label }}</p>
  <p>Via: {{ data.sepultura.via }}</p>
  <p>Tipo bloque: {{ data.sepultura.tipo_bloque }}</p>
  <p>Tipo lapida: {{ data.sepultura.tipo_lapida }}</p>
  <p>Orientacion: {{ data.sepultura.orientacion }}</p>
  <p>Titular actual: {{ data.active_titular.person.full_name if data.active_titular else '-' }}</p>
  <p>Beneficiario activo: {{ data.active_beneficiario.person.full_name if data.active_beneficiario else '-' }}</p>
  <p>Difuntos registrados: {{ data.difuntos|length }}</p>
</div>
{% elif data.tab == 'titularidad' %}
<div class="box">
  <h3>{{ t('cem.ownership') }}</h3>
  {% if data.contrato %}
  <div class="meta-row">
    <div>
      <strong>Titular actual:</strong>
      {% if data.active_titular %}
      <a href="{{ url_for('cemetery.person_edit', person_id=data.active_titular.person.id) }}">{{ data.active_titular.person.full_name }}</a>
      {% else %}
      -
      {% endif %}
    </div>
    <div>
      <strong>Beneficiario activo:</strong>
      {% if data.active_beneficiario %}
      <a href="{{ url_for('cemetery.person_edit', person_id=data.active_beneficiario.person.id) }}">{{ data.active_beneficiario.person.full_name }}</a>
      {% else %}
      -
      {% endif %}
    </div>
    {% if data.active_titular and data.active_titular.is_provisional %}
    <div><span class="flash warning">PROVISIONAL hasta {{ data.active_titular.provisional_until or '-' }}</span></div>
    {% endif %}
  </div>
  <h4>Histórico de titulares</h4>
  <table>
    <thead>
      <tr>
        <th>Persona</th>
        <th>Desde</th>
        <th>Hasta</th>
        <th>Pensionista</th>
        <th>Provisional</th>
      </tr>
    </thead>
    <tbody>
      {% for t_item in data.titulares %}
      <tr>
        <td><a href="{{ url_for('cemetery.person_edit', person_id=t_item.person.id) }}">{{ t_item.person.full_name }}</a></td>
        <td>{{ t_item.start_date }}</td>
        <td>{{ t_item.end_date or '-' }}</td>
        <td>{% if t_item.is_pensioner %}Sí ({{ t_item.pensioner_since_date or 's/f' }}){% else %}No{% endif %}</td>
        <td>{% if t_item.is_provisional %}{{ t('common.yes') }}{% else %}{{ t('common.no') }}{% endif %}</td>
      </tr>
      {% else %}
      <tr><td colspan="5">Sin titulares</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="quick-actions">
    <form class="inline-form" method="post" action="{{ url_for('cemetery.ownership_cases') }}">
      <input type="hidden" name="contract_id" value="{{ data.contrato.id }}">
      <select name="type" required>
        <option value="MORTIS_CAUSA_TESTAMENTO">MORTIS_CAUSA_TESTAMENTO</option>
        <option value="MORTIS_CAUSA_SIN_TESTAMENTO">MORTIS_CAUSA_SIN_TESTAMENTO</option>
        <option value="MORTIS_CAUSA_CON_BENEFICIARIO">MORTIS_CAUSA_CON_BENEFICIARIO</option>
        <option value="INTER_VIVOS">INTER_VIVOS</option>
        <option value="PROVISIONAL">PROVISIONAL</option>
      </select>
      <button class="btn primary" type="submit">Iniciar transmision</button>
    </form>
    <form method="post" action="{{ url_for('cemetery.nominate_beneficiary', contract_id=data.contrato.id) }}">
      <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
      {% with
        picker_id='titularidad-beneficiario-' ~ data.sepultura.id,
        field_name='person_id',
        label='Beneficiario',
        selected_person=(data.active_beneficiario.person if data.active_beneficiario else None),
        required=True
      %}
        {% include "components/person_picker.html" %}
      {% endwith %}
      <div class="actions-row">
        <button class="btn" type="submit">Nombrar/Editar beneficiario</button>
      </div>
    </form>
    <a class="btn" href="{{ url_for('cemetery.ownership_cases') }}">Ver casos</a>
  </div>
  {% else %}
  <p>No hay contrato activo asociado a esta sepultura.</p>
  {% endif %}
</div>
{% elif data.tab == 'titulares' %}
<div class="box">
  <h3>Titulares</h3>
  <table>
    <thead>
      <tr>
        <th>Persona</th>
        <th>Activo desde</th>
        <th>Activo hasta</th>
        <th>Pensionista</th>
      </tr>
    </thead>
    <tbody>
      {% for t_item in data.titulares %}
      <tr>
        <td><a href="{{ url_for('cemetery.person_edit', person_id=t_item.person.id) }}">{{ t_item.person.full_name }}</a></td>
        <td>{{ t_item.activo_desde }}</td>
        <td>{{ t_item.activo_hasta or '-' }}</td>
        <td>{% if t_item.pensionista %}Si ({{ t_item.pensionista_desde or 's/f' }}){% else %}No{% endif %}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">Sin titulares</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% if data.contrato %}
  <div class="quick-actions">
    <form class="inline-form" method="post" action="{{ url_for('cemetery.mark_holder_pensioner', contract_id=data.contrato.id) }}">
      <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
      <input type="date" name="since_date" required>
      <button class="btn" type="submit">Aplicar pensionista</button>
    </form>
    <form class="inline-form" method="post" action="{{ url_for('cemetery.ownership_cases') }}">
      <input type="hidden" name="contract_id" value="{{ data.contrato.id }}">
      <select name="type" required>
        <option value="INTER_VIVOS">INTER_VIVOS</option>
        <option value="MORTIS_CAUSA_TESTAMENTO">MORTIS_CAUSA_TESTAMENTO</option>
        <option value="MORTIS_CAUSA_SIN_TESTAMENTO">MORTIS_CAUSA_SIN_TESTAMENTO</option>
        <option value="MORTIS_CAUSA_CON_BENEFICIARIO">MORTIS_CAUSA_CON_BENEFICIARIO</option>
        <option value="PROVISIONAL">PROVISIONAL</option>
      </select>
      <button class="btn primary" type="submit">Cambiar titularidad (crear caso)</button>
    </form>
  </div>
  {% endif %}
</div>
{% elif data.tab == 'beneficiarios' %}
<div class="box">
  <h3>Beneficiarios</h3>
  <table>
    <thead>
      <tr>
        <th>Persona</th>
        <th>Activo desde</th>
        <th>Activo hasta</th>
      </tr>
    </thead>
    <tbody>
      {% for b_item in data.beneficiarios %}
      <tr>
        <td><a href="{{ url_for('cemetery.person_edit', person_id=b_item.person.id) }}">{{ b_item.person.full_name }}</a></td>
        <td>{{ b_item.activo_desde }}</td>
        <td>{{ b_item.activo_hasta or '-' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="3">Sin beneficiarios</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% if data.contrato %}
  <div class="quick-actions">
    <form method="post" action="{{ url_for('cemetery.nominate_beneficiary', contract_id=data.contrato.id) }}">
      <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
      {% with
        picker_id='beneficiarios-tab-' ~ data.sepultura.id,
        field_name='person_id',
        label='Beneficiario',
        selected_person=(data.active_beneficiario.person if data.active_beneficiario else None),
        required=True
      %}
        {% include "components/person_picker.html" %}
      {% endwith %}
      <div class="actions-row">
        <button class="btn" type="submit">Alta / editar beneficiario</button>
      </div>
    </form>
    <form class="inline-form" method="post" action="{{ url_for('cemetery.remove_beneficiary', contract_id=data.contrato.id) }}">
      <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
      <input type="date" name="end_date">
      <button class="btn" type="submit">Eliminar beneficiario</button>
    </form>
  </div>
  {% endif %}
</div>

{% elif data.tab == 'difuntos' %}
<div class="box">
  <h3>Difuntos</h3>
  <table>
    <thead>
      <tr>
        <th>Persona</th>
        <th>Notas</th>
        <th>Fecha alta</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for d_item in data.difuntos %}
      <tr>
        <td><a href="{{ url_for('cemetery.person_edit', person_id=d_item.person.id) }}">{{ d_item.person.full_name }}</a></td>
        <td>{{ d_item.notes or '-' }}</td>
        <td>{{ d_item.created_at.date() }}</td>
        <td>
          <form method="post" action="{{ url_for('cemetery.remove_deceased', sepultura_id=data.sepultura.id, sepultura_difunto_id=d_item.id) }}">
            <button class="btn" type="submit">Eliminar</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="4">Sin difuntos</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <form method="post" action="{{ url_for('cemetery.add_deceased', sepultura_id=data.sepultura.id) }}">
    {% with
      picker_id='difuntos-tab-' ~ data.sepultura.id,
      field_name='person_id',
      label='Difunto',
      selected_person=None,
      required=True
    %}
      {% include "components/person_picker.html" %}
    {% endwith %}
    <label>Notas</label>
    <input type="text" name="notes" placeholder="Observaciones de inhumación">
    <div class="actions-row">
      <button class="btn primary" type="submit">Registrar difunto</button>
    </div>
  </form>
</div>

{% elif data.tab == 'tasas' %}
<div class="box">
  <h3>{{ t('cem.fees') }}</h3>
  <table>
    <thead>
      <tr>
        <th>Año</th>
        <th>Importe</th>
        <th>Descuento</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody>
      {% for ticket in data.tasas %}
      <tr>
        <td>{{ ticket.anio }}</td>
        <td>{{ money(ticket.importe) }}</td>
        <td>{{ ticket.descuento_tipo.value }}</td>
        <td>{{ ticket.estado.value }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">Sin tiquets</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="actions-row">
    <a class="btn primary" href="{{ url_for('cemetery.fee_collection', sepultura_id=data.sepultura.id) }}">Ir a cobro de tasas</a>
  </div>
</div>
{% elif data.tab == 'derecho' %}
<div class="box">
  <h3>{{ t('cem.rights') }}</h3>
  {% if data.contrato %}
  <div class="meta-row">
    <div><strong>Tipo:</strong> {{ 'LLOGUER' if data.contrato.tipo.value == 'USO_INMEDIATO' else data.contrato.tipo.value }}</div>
    <div><strong>Inicio:</strong> {{ data.contrato.fecha_inicio }}</div>
    <div><strong>Fin:</strong> {{ data.contrato.fecha_fin }}</div>
    <div><strong>Importe anual base:</strong> {{ money(data.contrato.annual_fee_amount) }}</div>
    <div><strong>Legacy 99:</strong> {% if data.contrato.legacy_99_years %}Si{% else %}No{% endif %}</div>
  </div>
  <div class="meta-row">
    <div>
      <strong>Titular actual:</strong>
      {% if data.active_titular %}
      <a href="{{ url_for('cemetery.person_edit', person_id=data.active_titular.person.id) }}">{{ data.active_titular.person.full_name }}</a>
      {% else %}
      -
      {% endif %}
    </div>
    <div>
      <strong>Beneficiario actual:</strong>
      {% if data.active_beneficiario %}
      <a href="{{ url_for('cemetery.person_edit', person_id=data.active_beneficiario.person.id) }}">{{ data.active_beneficiario.person.full_name }}</a>
      {% else %}
      -
      {% endif %}
    </div>
  </div>
  <div class="quick-actions">
    <a class="btn primary" href="{{ url_for('cemetery.contract_title_pdf', contract_id=data.contrato.id) }}" target="_blank">{{ t('common.download') }} título (PDF)</a>
    <a class="btn" href="{{ url_for('module_pending', slug='ampliacion-derecho') }}">Ampliación</a>
    <a class="btn" href="{{ url_for('module_pending', slug='prorroga-derecho') }}">Prórroga</a>
  </div>
  {% else %}
  <form method="post" action="{{ url_for('cemetery.contract_create', sepultura_id=data.sepultura.id) }}">
    <div class="form-grid">
      <div>
        <label>Tipo</label>
        <select name="tipo" required>
          <option value="CONCESION">CONCESION</option>
          <option value="USO_INMEDIATO">LLOGUER (USO_INMEDIATO)</option>
        </select>
      </div>
      <div>
        <label>Importe anual base</label>
        <input type="text" name="annual_fee_amount" placeholder="45.00" required>
      </div>
      <div>
        <label>Fecha inicio</label>
        <input type="date" name="fecha_inicio" required>
      </div>
      <div>
        <label>Fecha fin</label>
        <input type="date" name="fecha_fin" required>
      </div>
    </div>
    {% with
      picker_id='contract-titular-' ~ data.sepultura.id,
      field_name='titular_person_id',
      label='Titular',
      selected_person=None,
      required=True
    %}
      {% include "components/person_picker.html" %}
    {% endwith %}
    {% with
      picker_id='contract-beneficiario-' ~ data.sepultura.id,
      field_name='beneficiario_person_id',
      label='Beneficiario (opcional)',
      selected_person=None,
      required=False
    %}
      {% include "components/person_picker.html" %}
    {% endwith %}
    <div class="form-grid">
      <div>
        <label>
          <input type="checkbox" name="pensionista"> Titular pensionista
        </label>
      </div>
      <div>
        <label>Pensionista desde</label>
        <input type="date" name="pensionista_desde">
      </div>
      <div>
        <label>
          <input type="checkbox" name="legacy_99_years"> Concesión legacy (hasta 99 años)
        </label>
      </div>
    </div>
    <div class="actions-row">
      <button class="btn primary" type="submit">Crear derecho funerario</button>
    </div>
  </form>
  {% endif %}
</div>
{% elif data.tab == 'lapidas' %}
<div class="box">
  <h3>{{ t('cem.engraving') }}</h3>
  <form class="inline-form" method="post" action="{{ url_for('cemetery.lapidas_create_inscripcion') }}">
    <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
    <input type="text" name="texto" placeholder="Texto de inscripción" required>
    <button class="btn" type="submit">Crear encargo de inscripción</button>
  </form>
  <div class="actions-row">
    <a class="btn primary" href="{{ url_for('cemetery.lapidas', sepultura_id=data.sepultura.id) }}">Abrir módulo de lápidas</a>
  </div>
</div>
{% else %}
<div class="box">
  <h3>Movimientos</h3>
  <form method="get" action="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id) }}">
    <input type="hidden" name="tab" value="movimientos">
    <div class="form-grid">
      <div>
        <label>Tipo</label>
        <select name="tipo">
          <option value="">Todos</option>
          <option value="INHUMACION">INHUMACION</option>
          <option value="EXHUMACION">EXHUMACION</option>
          <option value="TASAS">TASAS</option>
          <option value="LAPIDA">LAPIDA</option>
          <option value="CAMBIO_ESTADO">CAMBIO_ESTADO</option>
          <option value="CONTRATO">CONTRATO</option>
          <option value="INSCRIPCION_LATERAL">INSCRIPCION_LATERAL</option>
        </select>
      </div>
      <div>
        <label>Desde</label>
        <input type="date" name="desde" value="{{ request.args.get('desde', '') }}">
      </div>
      <div>
        <label>Hasta</label>
        <input type="date" name="hasta" value="{{ request.args.get('hasta', '') }}">
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button type="submit">Aplicar</button>
      </div>
    </div>
  </form>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Tipo</th>
        <th>Detalle</th>
        <th>Usuario</th>
      </tr>
    </thead>
    <tbody>
      {% for mov in data.movimientos %}
      <tr>
        <td>{{ mov.fecha.date() }}</td>
        <td>{{ mov.tipo.value }}</td>
        <td>{{ mov.detalle }}</td>
        <td>{{ mov.user.full_name if mov.user else 'sistema' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">{{ t('common.no_results') }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}
{% endblock %}
