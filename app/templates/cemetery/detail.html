<!-- Spec 9.4.3 / 9.4.4 / 9.4.5 / 9.1.7 - Ficha de sepultura -->
{% extends "base.html" %}
{% set active_cem = 'sepulturas' %}
{% block title %}Sepultura {{ data.sepultura.location_label }}{% endblock %}
{% block content %}
<h1 class="page-title">Sepultura {{ data.sepultura.location_label }}</h1>

<div class="box">
  <div class="meta-row">
    <div><strong>Modalidad:</strong> {{ data.sepultura.modalidad }}</div>
    <div><strong>Estado:</strong> {{ data.sepultura.estado.value }}</div>
    {% if data.contrato %}
    <div>
      <strong>Contrato:</strong>
      {{ 'LLOGUER' if data.contrato.tipo.value == 'USO_INMEDIATO' else data.contrato.tipo.value }}
      ({{ data.contrato.fecha_inicio }} - {{ data.contrato.fecha_fin }})
    </div>
    {% endif %}
  </div>
  <div class="quick-actions">
    <form class="inline-form" method="post" action="{{ url_for('cemetery.change_state', sepultura_id=data.sepultura.id) }}">
      <select name="estado">
        <option value="LLIURE">LLIURE</option>
        <option value="DISPONIBLE">DISPONIBLE</option>
        <option value="INACTIVA">INACTIVA</option>
        <option value="PROPIA">PROPIA</option>
      </select>
      <button type="submit">Cambiar estado</button>
    </form>
    <a class="btn" href="{{ url_for('cemetery.fee_collection', sepultura_id=data.sepultura.id) }}">Cobrar tasas</a>
    {% if not data.contrato %}
    <a class="btn" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='derecho') }}">Contratar derecho funerario</a>
    {% endif %}
    <a class="btn" href="#">Nuevo exp.</a>
  </div>
</div>

<div class="cem-submenu">
  <a class="tab-link {% if data.tab == 'resumen' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='resumen') }}">Resumen</a>
  <a class="tab-link {% if data.tab == 'titulares' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='titulares') }}">Titulares</a>
  <a class="tab-link {% if data.tab == 'beneficiarios' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='beneficiarios') }}">Beneficiarios</a>
  <a class="tab-link {% if data.tab == 'movimientos' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='movimientos') }}">Movimientos</a>
  <a class="tab-link {% if data.tab == 'tasas' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='tasas') }}">Tasas</a>
  <a class="tab-link {% if data.tab == 'derecho' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='derecho') }}">Derecho funerario</a>
  <a class="tab-link {% if data.tab == 'lapidas' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='lapidas') }}">Lapidas/Inscr.</a>
</div>

{% if data.tab == 'resumen' %}
<div class="box">
  <h3>Resumen</h3>
  <p>Ubicacion: {{ data.sepultura.location_label }}</p>
  <p>Via: {{ data.sepultura.via }}</p>
  <p>Tipo bloque: {{ data.sepultura.tipo_bloque }}</p>
  <p>Tipo lapida: {{ data.sepultura.tipo_lapida }}</p>
  <p>Orientacion: {{ data.sepultura.orientacion }}</p>
</div>
{% elif data.tab == 'titulares' %}
<div class="box">
  <h3>Titulares</h3>
  <table>
    <thead>
      <tr>
        <th>Persona</th>
        <th>Activo desde</th>
        <th>Activo hasta</th>
        <th>Pensionista</th>
      </tr>
    </thead>
    <tbody>
      {% for t_item in data.titulares %}
      <tr>
        <td>{{ t_item.person.full_name }}</td>
        <td>{{ t_item.activo_desde }}</td>
        <td>{{ t_item.activo_hasta or '-' }}</td>
        <td>{% if t_item.pensionista %}Si ({{ t_item.pensionista_desde or 's/f' }}){% else %}No{% endif %}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">Sin titulares</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% elif data.tab == 'beneficiarios' %}
<div class="box">
  <h3>Beneficiarios</h3>
  <table>
    <thead>
      <tr>
        <th>Persona</th>
        <th>Activo desde</th>
        <th>Activo hasta</th>
      </tr>
    </thead>
    <tbody>
      {% for b_item in data.beneficiarios %}
      <tr>
        <td>{{ b_item.person.full_name }}</td>
        <td>{{ b_item.activo_desde }}</td>
        <td>{{ b_item.activo_hasta or '-' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="3">Sin beneficiarios</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% elif data.tab == 'tasas' %}
<div class="box">
  <h3>Tasas</h3>
  <table>
    <thead>
      <tr>
        <th>Anio</th>
        <th>Importe</th>
        <th>Descuento</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody>
      {% for ticket in data.tasas %}
      <tr>
        <td>{{ ticket.anio }}</td>
        <td>{{ money(ticket.importe) }}</td>
        <td>{{ ticket.descuento_tipo.value }}</td>
        <td>{{ ticket.estado.value }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">Sin tiquets</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="actions-row">
    <a class="btn primary" href="{{ url_for('cemetery.fee_collection', sepultura_id=data.sepultura.id) }}">Ir a cobro de tasas</a>
  </div>
</div>
{% elif data.tab == 'derecho' %}
<div class="box">
  <h3>Derecho funerario</h3>
  {% if data.contrato %}
  <div class="meta-row">
    <div><strong>Tipo:</strong> {{ 'LLOGUER' if data.contrato.tipo.value == 'USO_INMEDIATO' else data.contrato.tipo.value }}</div>
    <div><strong>Inicio:</strong> {{ data.contrato.fecha_inicio }}</div>
    <div><strong>Fin:</strong> {{ data.contrato.fecha_fin }}</div>
    <div><strong>Importe anual base:</strong> {{ money(data.contrato.annual_fee_amount) }}</div>
    <div><strong>Legacy 99:</strong> {% if data.contrato.legacy_99_years %}Si{% else %}No{% endif %}</div>
  </div>
  <div class="meta-row">
    <div><strong>Titular actual:</strong> {{ data.active_titular.person.full_name if data.active_titular else '-' }}</div>
    <div><strong>Beneficiario actual:</strong> {{ data.active_beneficiario.person.full_name if data.active_beneficiario else '-' }}</div>
  </div>
  <div class="quick-actions">
    <a class="btn primary" href="{{ url_for('cemetery.contract_title_pdf', contract_id=data.contrato.id) }}" target="_blank">Descargar titulo (PDF)</a>
    <button class="btn" disabled>Ampliacion (pendiente)</button>
    <button class="btn" disabled>Prorroga (pendiente)</button>
  </div>
  {% else %}
  <form method="post" action="{{ url_for('cemetery.contract_create', sepultura_id=data.sepultura.id) }}">
    <div class="form-grid">
      <div>
        <label>Tipo</label>
        <select name="tipo" required>
          <option value="CONCESION">CONCESION</option>
          <option value="USO_INMEDIATO">LLOGUER (USO_INMEDIATO)</option>
        </select>
      </div>
      <div>
        <label>Importe anual base</label>
        <input type="text" name="annual_fee_amount" placeholder="45.00" required>
      </div>
      <div>
        <label>Fecha inicio</label>
        <input type="date" name="fecha_inicio" required>
      </div>
      <div>
        <label>Fecha fin</label>
        <input type="date" name="fecha_fin" required>
      </div>
      <div>
        <label>Nombre titular</label>
        <input type="text" name="titular_first_name" required>
      </div>
      <div>
        <label>Apellidos titular</label>
        <input type="text" name="titular_last_name">
      </div>
      <div>
        <label>Documento titular</label>
        <input type="text" name="titular_document_id">
      </div>
      <div>
        <label>Beneficiario (nombre, opcional)</label>
        <input type="text" name="beneficiario_first_name">
      </div>
      <div>
        <label>Beneficiario (apellidos)</label>
        <input type="text" name="beneficiario_last_name">
      </div>
      <div>
        <label>Documento beneficiario</label>
        <input type="text" name="beneficiario_document_id">
      </div>
      <div>
        <label>
          <input type="checkbox" name="pensionista"> Titular pensionista
        </label>
      </div>
      <div>
        <label>Pensionista desde</label>
        <input type="date" name="pensionista_desde">
      </div>
      <div>
        <label>
          <input type="checkbox" name="legacy_99_years"> Concesion legacy (hasta 99 anos)
        </label>
      </div>
    </div>
    <div class="actions-row">
      <button class="btn primary" type="submit">Contratar derecho funerario</button>
    </div>
  </form>
  {% endif %}
</div>
{% elif data.tab == 'lapidas' %}
<div class="box">
  <h3>Lapidas/Inscripciones</h3>
  <p>MVP preparado. Gestion completa pendiente para siguiente iteracion.</p>
</div>
{% else %}
<div class="box">
  <h3>Movimientos (filtrable)</h3>
  <form method="get" action="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id) }}">
    <input type="hidden" name="tab" value="movimientos">
    <div class="form-grid">
      <div>
        <label>Tipo</label>
        <select name="tipo">
          <option value="">Todos</option>
          <option value="INHUMACION">INHUMACION</option>
          <option value="EXHUMACION">EXHUMACION</option>
          <option value="TASAS">TASAS</option>
          <option value="LAPIDA">LAPIDA</option>
          <option value="CAMBIO_ESTADO">CAMBIO_ESTADO</option>
          <option value="CONTRATO">CONTRATO</option>
          <option value="INSCRIPCION_LATERAL">INSCRIPCION_LATERAL</option>
        </select>
      </div>
      <div>
        <label>Desde</label>
        <input type="date" name="desde" value="{{ request.args.get('desde', '') }}">
      </div>
      <div>
        <label>Hasta</label>
        <input type="date" name="hasta" value="{{ request.args.get('hasta', '') }}">
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button type="submit">Aplicar</button>
      </div>
    </div>
  </form>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Tipo</th>
        <th>Detalle</th>
        <th>Usuario</th>
      </tr>
    </thead>
    <tbody>
      {% for mov in data.movimientos %}
      <tr>
        <td>{{ mov.fecha.date() }}</td>
        <td>{{ mov.tipo.value }}</td>
        <td>{{ mov.detalle }}</td>
        <td>{{ mov.user.full_name if mov.user else 'sistema' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">Sin movimientos</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}
{% endblock %}
