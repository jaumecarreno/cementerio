<!-- Spec 9.4.3 / 9.4.4 / 9.4.5 / 9.1.7 - Ficha de sepultura -->
{% extends "base.html" %}
{% set active_cem = 'sepulturas' %}
{% block title %}{{ t('field.grave') }} {{ data.sepultura.location_label }}{% endblock %}
{% block content %}
{% from "partials/icons.html" import action_icon %}
<h1 class="page-title">{{ t('field.grave') }} {{ data.sepultura.location_label }}</h1>

<div class="box">
  <div class="meta-row">
    <div><strong>Modalidad:</strong> {{ data.sepultura.modalidad }}</div>
    <div><strong>Estado:</strong> {{ data.sepultura.estado.value }}</div>
    {% if data.contrato %}
    <div>
      <strong>Contrato:</strong>
      {{ 'LLOGUER' if data.contrato.tipo.value == 'USO_INMEDIATO' else data.contrato.tipo.value }}
      ({{ data.contrato.fecha_inicio }} - {{ data.contrato.fecha_fin }})
    </div>
    {% endif %}
  </div>
  {% if data.tab != 'principal' %}
  <div class="quick-actions">
    <form class="inline-form" method="post" action="{{ url_for('cemetery.change_state', sepultura_id=data.sepultura.id) }}">
      <select name="estado">
        <option value="LLIURE">LLIURE</option>
        <option value="DISPONIBLE">DISPONIBLE</option>
        <option value="INACTIVA">INACTIVA</option>
        <option value="PROPIA">PROPIA</option>
      </select>
      <button type="submit">Cambiar estado</button>
    </form>
    <a class="btn" href="{{ url_for('cemetery.fee_collection', sepultura_id=data.sepultura.id) }}">Cobrar tasas</a>
    {% if not data.contrato %}
    <a class="btn" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='derecho') }}">Crear derecho funerario</a>
    {% endif %}
    <a class="btn" href="{{ url_for('cemetery.expedientes', sepultura_id=data.sepultura.id) }}">Nuevo exp.</a>
    <a class="btn" href="{{ url_for('cemetery.ownership_cases') }}">{{ t('cem.ownership') }}</a>
    <a class="btn" href="{{ url_for('cemetery.lapidas', sepultura_id=data.sepultura.id) }}">LÃ¡pidas</a>
  </div>
  {% endif %}
</div>

<div class="cem-submenu">
  <a class="tab-link {% if data.tab == 'principal' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='principal') }}">Principal</a>
  <a class="tab-link {% if data.tab == 'resumen' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='resumen') }}">Resumen</a>
  <a class="tab-link {% if data.tab == 'titularidad' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='titularidad') }}">Titularidad</a>
  <a class="tab-link {% if data.tab == 'titulares' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='titulares') }}">Titulares</a>
  <a class="tab-link {% if data.tab == 'beneficiarios' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='beneficiarios') }}">Beneficiarios</a>
  <a class="tab-link {% if data.tab == 'difuntos' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='difuntos') }}">Difuntos</a>
  <a class="tab-link {% if data.tab == 'movimientos' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='movimientos') }}">Movimientos</a>
  <a class="tab-link {% if data.tab == 'tasas' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='tasas') }}">Tasas</a>
  <a class="tab-link {% if data.tab == 'derecho' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='derecho') }}">{{ t('cem.rights') }}</a>
  <a class="tab-link {% if data.tab == 'notas' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='notas') }}">Notas</a>
  <a class="tab-link {% if data.tab == 'lapidas' %}active{% endif %}" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='lapidas') }}">{{ t('cem.engraving') }}</a>
</div>

{% if data.tab == 'principal' %}
{% set titular_person = data.active_titular.person if data.active_titular else none %}
{% set beneficiario_person = data.active_beneficiario.person if data.active_beneficiario else none %}
{% set representante_person = data.representante %}
{% set tasas_limit = 5 %}
{% set visible_tasas = data.tasas[:tasas_limit] %}
{% set hidden_tasas = data.tasas[tasas_limit:] %}
{% set titular_phone_value = [titular_person.telefono, titular_person.telefono2]|select|join(', ') if titular_person else '' %}
{% set titular_email_value = [titular_person.email, titular_person.email2]|select|join(', ') if titular_person else '' %}
{% set titular_locality_value = [titular_person.codigo_postal, titular_person.poblacion]|select|join(' ') if titular_person else '' %}
{% set titular_address_value = [titular_person.direccion_linea, titular_locality_value, titular_person.provincia]|select|join(', ') if titular_person else '' %}
{% set beneficiario_phone_value = [beneficiario_person.telefono, beneficiario_person.telefono2]|select|join(', ') if beneficiario_person else '' %}
{% set beneficiario_email_value = [beneficiario_person.email, beneficiario_person.email2]|select|join(', ') if beneficiario_person else '' %}
{% set beneficiario_locality_value = [beneficiario_person.codigo_postal, beneficiario_person.poblacion]|select|join(' ') if beneficiario_person else '' %}
{% set beneficiario_address_value = [beneficiario_person.direccion_linea, beneficiario_locality_value, beneficiario_person.provincia]|select|join(', ') if beneficiario_person else '' %}
<section class="detail-cards">
  {% if data.sepultura.postit %}
  <div class="box detail-card detail-card-wide postit-card">
    <div class="detail-card-head">
      <h3>Post it</h3>
    </div>
    <p class="postit-card-text">{{ data.sepultura.postit }}</p>
  </div>
  {% endif %}

  <div class="box detail-card">
    <div class="detail-card-head">
      <div class="detail-card-title-row">
        <h3>Titular</h3>
        {% if titular_person %}
        <a
          class="icon-btn"
          href="{{ url_for('cemetery.person_edit', person_id=titular_person.id) }}"
          title="Editar titular"
          aria-label="Editar titular"
        >{{ action_icon('edit') }}</a>
        {% endif %}
      </div>
      {% if data.contrato %}
      <a class="btn primary" href="{{ url_for('cemetery.ownership_cases', prefill_contract_id=data.contrato.id) }}">Cambiar titular</a>
      {% else %}
      <span class="small muted">Sin contrato activo</span>
      {% endif %}
    </div>
    <div class="detail-meta">
      <div class="detail-meta-item"><span class="detail-meta-label">Nombre</span><span class="detail-meta-value">{{ titular_person.full_name if titular_person else '-' }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Telefono</span><span class="detail-meta-value">{{ titular_phone_value or '-' }}</span></div>
      <div class="detail-meta-item">
        <span class="detail-meta-label">Email</span>
        <span class="detail-meta-value wrap">
          <span>{{ titular_email_value or '-' }}</span>
          {% if titular_email_value %}
          <button
            type="button"
            class="copy-email-btn"
            data-copy-text="{{ titular_email_value }}"
            title="Copiar email"
            aria-label="Copiar email titular"
          >&#x2398;</button>
          {% endif %}
        </span>
      </div>
      <div class="detail-meta-item"><span class="detail-meta-label">DNI/NIF</span><span class="detail-meta-value">{{ titular_person.dni_nif if titular_person else '-' }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Direccion</span><span class="detail-meta-value">{{ titular_address_value or (titular_person.direccion_linea if titular_person else '-') or '-' }}</span></div>
      <div class="detail-meta-item">
        <span class="detail-meta-label">Pensionista</span>
        <span class="detail-meta-value wrap">
          <label class="detail-checkbox">
            <input type="checkbox" disabled {% if data.active_titular and data.active_titular.is_pensioner %}checked{% endif %}>
            <span>{% if data.active_titular and data.active_titular.is_pensioner %}Si{% else %}No{% endif %}</span>
          </label>
          {% if data.active_titular and data.active_titular.is_pensioner %}
          <span class="pensionista-badge">Pensionista</span>
          {% endif %}
        </span>
      </div>
    </div>
  </div>

  <div class="box detail-card">
    <div class="detail-card-head">
      <div class="detail-card-title-row">
        <h3>Beneficiario</h3>
        {% if beneficiario_person %}
        <a
          class="icon-btn"
          href="{{ url_for('cemetery.person_edit', person_id=beneficiario_person.id) }}"
          title="Editar beneficiario"
          aria-label="Editar beneficiario"
        >{{ action_icon('edit') }}</a>
        {% else %}
        <span class="beneficiario-alert-icon" title="Sin beneficiario activo" aria-label="Sin beneficiario activo">!</span>
        {% endif %}
      </div>
      {% if data.contrato %}
      <a class="btn" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='beneficiarios') }}">Cambiar beneficiario</a>
      {% endif %}
    </div>
    <div class="detail-meta">
      <div class="detail-meta-item"><span class="detail-meta-label">Nombre</span><span class="detail-meta-value">{{ beneficiario_person.full_name if beneficiario_person else '' }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Telefono</span><span class="detail-meta-value">{{ beneficiario_phone_value or '' }}</span></div>
      <div class="detail-meta-item">
        <span class="detail-meta-label">Email</span>
        <span class="detail-meta-value wrap">
          <span>{{ beneficiario_email_value or '' }}</span>
          {% if beneficiario_email_value %}
          <button
            type="button"
            class="copy-email-btn"
            data-copy-text="{{ beneficiario_email_value }}"
            title="Copiar email"
            aria-label="Copiar email beneficiario"
          >&#x2398;</button>
          {% endif %}
        </span>
      </div>
      <div class="detail-meta-item"><span class="detail-meta-label">DNI/NIF</span><span class="detail-meta-value">{{ beneficiario_person.dni_nif if beneficiario_person else '' }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Direccion</span><span class="detail-meta-value">{{ beneficiario_address_value or (beneficiario_person.direccion_linea if beneficiario_person else '') }}</span></div>
    </div>
  </div>

  <div class="box detail-card">
    <div class="detail-card-head">
      <h3>Representante</h3>
    </div>
    {% if representante_person %}
    <div class="detail-meta">
      <div class="detail-meta-item"><span class="detail-meta-label">Nombre</span><span class="detail-meta-value">{{ representante_person.full_name }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Telefono</span><span class="detail-meta-value">{{ representante_person.telefono or '-' }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Email</span><span class="detail-meta-value">{{ representante_person.email or '-' }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">DNI/NIF</span><span class="detail-meta-value">{{ representante_person.dni_nif or '-' }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Direccion</span><span class="detail-meta-value">{{ representante_person.direccion or '-' }}</span></div>
    </div>
    {% else %}
    <div class="detail-empty-action">
      <a class="btn primary" href="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id, tab='titularidad') }}">Anadir representante</a>
    </div>
    {% endif %}
  </div>

  <div class="box detail-card detail-card-wide">
    <h3>Difuntos</h3>
    <table class="table-zebra detail-table-compact">
      <thead>
        <tr>
          <th>Persona</th>
          <th>Fecha alta</th>
          <th>Notas</th>
        </tr>
      </thead>
      <tbody>
        {% for d_item in data.difuntos %}
        <tr>
          <td>{{ d_item.person.full_name }}</td>
          <td>{{ d_item.created_at.date() }}</td>
          <td>{{ d_item.notes or '-' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3">Sin difuntos</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="box detail-card">
    <h3>Tasas</h3>
    <table class="table-zebra detail-table-compact">
      <thead>
        <tr>
          <th>Ano</th>
          <th>Estado</th>
          <th>Importe</th>
        </tr>
      </thead>
      <tbody>
        {% for ticket in visible_tasas %}
        <tr>
          <td>{{ ticket.anio }}</td>
          <td>{{ ticket.estado.value }}</td>
          <td>{{ money(ticket.importe) }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3">Sin tasas</td></tr>
        {% endfor %}
      </tbody>
      {% if hidden_tasas %}
      <tbody id="tasas-extra-{{ data.sepultura.id }}" hidden>
        {% for ticket in hidden_tasas %}
        <tr>
          <td>{{ ticket.anio }}</td>
          <td>{{ ticket.estado.value }}</td>
          <td>{{ money(ticket.importe) }}</td>
        </tr>
        {% endfor %}
      </tbody>
      {% endif %}
    </table>
    <div class="actions-row">
      <a class="btn primary" href="{{ url_for('cemetery.fee_collection', sepultura_id=data.sepultura.id) }}">Cobrar tasas</a>
      {% if hidden_tasas %}
      <button
        type="button"
        class="text-toggle-btn"
        data-toggle-target="tasas-extra-{{ data.sepultura.id }}"
        data-open-label="Ver mas tasas"
        data-close-label="Ver menos tasas"
      >Ver mas tasas</button>
      {% endif %}
    </div>
  </div>

  <div class="box detail-card">
    <h3>{{ t('cem.rights') }}</h3>
    {% if data.contrato %}
    <div class="detail-meta">
      <div class="detail-meta-item"><span class="detail-meta-label">Tipo</span><span class="detail-meta-value">{{ 'LLOGUER' if data.contrato.tipo.value == 'USO_INMEDIATO' else data.contrato.tipo.value }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Inicio</span><span class="detail-meta-value">{{ data.contrato.fecha_inicio }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Fin</span><span class="detail-meta-value">{{ data.contrato.fecha_fin }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Importe anual</span><span class="detail-meta-value">{{ money(data.contrato.annual_fee_amount) }}</span></div>
    </div>
    <div class="actions-row">
      <a class="btn primary" href="{{ url_for('cemetery.contract_title_pdf', contract_id=data.contrato.id) }}" target="_blank">Descargar titulo (PDF)</a>
      <a class="btn" href="{{ url_for('module_pending', slug='ampliacion-derecho') }}">Ampliacion</a>
      <a class="btn" href="{{ url_for('module_pending', slug='prorroga-derecho') }}">Prorroga</a>
    </div>
    {% else %}
    <p>No hay contrato activo asociado a esta sepultura.</p>
    {% endif %}
  </div>

  <div class="box detail-card">
    <h3>Caracteristicas de la sepultura</h3>
    <div class="detail-meta detail-meta--3">
      <div class="detail-meta-item"><span class="detail-meta-label">Ubicacion</span><span class="detail-meta-value">{{ data.sepultura.location_label }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Via</span><span class="detail-meta-value">{{ data.sepultura.via }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Tipo bloque</span><span class="detail-meta-value">{{ data.sepultura.tipo_bloque }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Tipo lapida</span><span class="detail-meta-value">{{ data.sepultura.tipo_lapida }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Orientacion</span><span class="detail-meta-value">{{ data.sepultura.orientacion }}</span></div>
      <div class="detail-meta-item"><span class="detail-meta-label">Difuntos</span><span class="detail-meta-value">{{ data.difuntos_count }}</span></div>
    </div>
  </div>

  <div class="box detail-card detail-card-wide">
    <h3>Lapidas / inscripciones</h3>
    <table class="table-zebra detail-table-compact">
      <thead>
        <tr>
          <th>Texto</th>
          <th>Estado</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        {% for inscripcion in data.inscripciones %}
        <tr>
          <td>{{ inscripcion.texto }}</td>
          <td>{{ inscripcion.estado }}</td>
          <td>{{ inscripcion.created_at.date() }}</td>
        </tr>
        {% else %}
        <tr><td colspan="3">Sin inscripciones</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="box detail-card detail-card-wide">
    <h3>Movimientos</h3>
    <table class="table-zebra detail-table-compact">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Detalle</th>
          <th>Usuario</th>
        </tr>
      </thead>
      <tbody>
        {% for mov in data.movimientos %}
        <tr>
          <td>{{ mov.fecha.date() }}</td>
          <td>{{ mov.tipo.value }}</td>
          <td>{{ mov.detalle }}</td>
          <td>{{ mov.user.full_name if mov.user else 'sistema' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="4">{{ t('common.no_results') }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
<script>
  (function () {
    function fallbackCopy(value) {
      const el = document.createElement("textarea");
      el.value = value;
      el.setAttribute("readonly", "");
      el.style.position = "absolute";
      el.style.left = "-9999px";
      document.body.appendChild(el);
      el.select();
      document.execCommand("copy");
      document.body.removeChild(el);
    }

    function handleCopyButton(button) {
      const value = button.getAttribute("data-copy-text") || "";
      if (!value) return;
      const applyCopiedState = function () {
        button.classList.add("is-copied");
        window.setTimeout(function () {
          button.classList.remove("is-copied");
        }, 900);
      };
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(value).then(applyCopiedState).catch(function () {
          fallbackCopy(value);
          applyCopiedState();
        });
        return;
      }
      fallbackCopy(value);
      applyCopiedState();
    }

    function handleTextToggle(button) {
      const targetId = button.getAttribute("data-toggle-target");
      if (!targetId) return;
      const target = document.getElementById(targetId);
      if (!target) return;
      const openLabel = button.getAttribute("data-open-label") || "Ver mas";
      const closeLabel = button.getAttribute("data-close-label") || "Ver menos";
      const nextOpen = target.hidden;
      target.hidden = !nextOpen;
      button.textContent = nextOpen ? closeLabel : openLabel;
    }

    document.addEventListener("click", function (event) {
      const copyButton = event.target.closest(".copy-email-btn");
      if (copyButton) {
        handleCopyButton(copyButton);
        return;
      }
      const toggleButton = event.target.closest(".text-toggle-btn");
      if (toggleButton) {
        handleTextToggle(toggleButton);
      }
    });
  })();
</script>
{% elif data.tab == 'resumen' %}
<div class="box">
  <h3>{{ t('common.summary') }}</h3>
  <p>Ubicacion: {{ data.sepultura.location_label }}</p>
  <p>Via: {{ data.sepultura.via }}</p>
  <p>Tipo bloque: {{ data.sepultura.tipo_bloque }}</p>
  <p>Tipo lapida: {{ data.sepultura.tipo_lapida }}</p>
  <p>Orientacion: {{ data.sepultura.orientacion }}</p>
  <p>Titular actual: {{ data.active_titular.person.full_name if data.active_titular else '-' }}</p>
  <p>Beneficiario activo: {{ data.active_beneficiario.person.full_name if data.active_beneficiario else '-' }}</p>
  <p>Difuntos registrados: {{ data.difuntos|length }}</p>
</div>
{% elif data.tab == 'titularidad' %}
<div class="box">
  <h3>{{ t('cem.ownership') }}</h3>
  {% if data.contrato %}
  <div class="meta-row">
    <div>
      <strong>Titular actual:</strong>
      {% if data.active_titular %}
      <a href="{{ url_for('cemetery.person_edit', person_id=data.active_titular.person.id) }}">{{ data.active_titular.person.full_name }}</a>
      {% else %}
      -
      {% endif %}
    </div>
    <div>
      <strong>Beneficiario activo:</strong>
      {% if data.active_beneficiario %}
      <a href="{{ url_for('cemetery.person_edit', person_id=data.active_beneficiario.person.id) }}">{{ data.active_beneficiario.person.full_name }}</a>
      {% else %}
      -
      {% endif %}
    </div>
    {% if data.active_titular and data.active_titular.is_provisional %}
    <div><span class="flash warning">PROVISIONAL hasta {{ data.active_titular.provisional_until or '-' }}</span></div>
    {% endif %}
  </div>
  <h4>HistÃ³rico de titulares</h4>
  <table>
    <thead>
      <tr>
        <th>Persona</th>
        <th>Desde</th>
        <th>Hasta</th>
        <th>Pensionista</th>
        <th>Provisional</th>
      </tr>
    </thead>
    <tbody>
      {% for t_item in data.titulares %}
      <tr>
        <td><a href="{{ url_for('cemetery.person_edit', person_id=t_item.person.id) }}">{{ t_item.person.full_name }}</a></td>
        <td>{{ t_item.start_date }}</td>
        <td>{{ t_item.end_date or '-' }}</td>
        <td>{% if t_item.is_pensioner %}SÃ­ ({{ t_item.pensioner_since_date or 's/f' }}){% else %}No{% endif %}</td>
        <td>{% if t_item.is_provisional %}{{ t('common.yes') }}{% else %}{{ t('common.no') }}{% endif %}</td>
      </tr>
      {% else %}
      <tr><td colspan="5">Sin titulares</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="quick-actions">
    <form class="inline-form" method="post" action="{{ url_for('cemetery.ownership_cases') }}">
      <input type="hidden" name="contract_id" value="{{ data.contrato.id }}">
      <select name="type" required>
        <option value="MORTIS_CAUSA_TESTAMENTO">MORTIS_CAUSA_TESTAMENTO</option>
        <option value="MORTIS_CAUSA_SIN_TESTAMENTO">MORTIS_CAUSA_SIN_TESTAMENTO</option>
        <option value="MORTIS_CAUSA_CON_BENEFICIARIO">MORTIS_CAUSA_CON_BENEFICIARIO</option>
        <option value="INTER_VIVOS">INTER_VIVOS</option>
        <option value="PROVISIONAL">PROVISIONAL</option>
      </select>
      <button class="btn primary" type="submit">Iniciar transmision</button>
    </form>
    <form method="post" action="{{ url_for('cemetery.nominate_beneficiary', contract_id=data.contrato.id) }}">
      <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
      {% with
        picker_id='titularidad-beneficiario-' ~ data.sepultura.id,
        field_name='person_id',
        label='Beneficiario',
        selected_person=(data.active_beneficiario.person if data.active_beneficiario else None),
        required=True
      %}
        {% include "components/person_picker.html" %}
      {% endwith %}
      <div class="actions-row">
        <button class="btn" type="submit">Nombrar/Editar beneficiario</button>
      </div>
    </form>
    <a class="btn" href="{{ url_for('cemetery.ownership_cases') }}">Ver casos</a>
  </div>
  {% else %}
  <p>No hay contrato activo asociado a esta sepultura.</p>
  {% endif %}
</div>
{% elif data.tab == 'titulares' %}
<div class="box">
  <h3>Titulares</h3>
  <table>
    <thead>
      <tr>
        <th>Persona</th>
        <th>Activo desde</th>
        <th>Activo hasta</th>
        <th>Pensionista</th>
      </tr>
    </thead>
    <tbody>
      {% for t_item in data.titulares %}
      <tr>
        <td><a href="{{ url_for('cemetery.person_edit', person_id=t_item.person.id) }}">{{ t_item.person.full_name }}</a></td>
        <td>{{ t_item.activo_desde }}</td>
        <td>{{ t_item.activo_hasta or '-' }}</td>
        <td>{% if t_item.pensionista %}Si ({{ t_item.pensionista_desde or 's/f' }}){% else %}No{% endif %}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">Sin titulares</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% if data.contrato %}
  <div class="quick-actions">
    <form class="inline-form" method="post" action="{{ url_for('cemetery.mark_holder_pensioner', contract_id=data.contrato.id) }}">
      <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
      <input type="date" name="since_date" required>
      <button class="btn" type="submit">Aplicar pensionista</button>
    </form>
    <form class="inline-form" method="post" action="{{ url_for('cemetery.ownership_cases') }}">
      <input type="hidden" name="contract_id" value="{{ data.contrato.id }}">
      <select name="type" required>
        <option value="INTER_VIVOS">INTER_VIVOS</option>
        <option value="MORTIS_CAUSA_TESTAMENTO">MORTIS_CAUSA_TESTAMENTO</option>
        <option value="MORTIS_CAUSA_SIN_TESTAMENTO">MORTIS_CAUSA_SIN_TESTAMENTO</option>
        <option value="MORTIS_CAUSA_CON_BENEFICIARIO">MORTIS_CAUSA_CON_BENEFICIARIO</option>
        <option value="PROVISIONAL">PROVISIONAL</option>
      </select>
      <button class="btn primary" type="submit">Cambiar titularidad (crear caso)</button>
    </form>
  </div>
  {% endif %}
</div>
{% elif data.tab == 'beneficiarios' %}
<div class="box">
  <h3>Beneficiarios</h3>
  <table>
    <thead>
      <tr>
        <th>Persona</th>
        <th>Activo desde</th>
        <th>Activo hasta</th>
      </tr>
    </thead>
    <tbody>
      {% for b_item in data.beneficiarios %}
      <tr>
        <td><a href="{{ url_for('cemetery.person_edit', person_id=b_item.person.id) }}">{{ b_item.person.full_name }}</a></td>
        <td>{{ b_item.activo_desde }}</td>
        <td>{{ b_item.activo_hasta or '-' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="3">Sin beneficiarios</td></tr>
      {% endfor %}
    </tbody>
  </table>
  {% if data.contrato %}
  <div class="quick-actions">
    <form method="post" action="{{ url_for('cemetery.nominate_beneficiary', contract_id=data.contrato.id) }}">
      <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
      {% with
        picker_id='beneficiarios-tab-' ~ data.sepultura.id,
        field_name='person_id',
        label='Beneficiario',
        selected_person=(data.active_beneficiario.person if data.active_beneficiario else None),
        required=True
      %}
        {% include "components/person_picker.html" %}
      {% endwith %}
      <div class="actions-row">
        <button class="btn" type="submit">Alta / editar beneficiario</button>
      </div>
    </form>
    <form class="inline-form" method="post" action="{{ url_for('cemetery.remove_beneficiary', contract_id=data.contrato.id) }}">
      <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
      <input type="date" name="end_date">
      <button class="btn" type="submit">Eliminar beneficiario</button>
    </form>
  </div>
  {% endif %}
</div>

{% elif data.tab == 'difuntos' %}
<div class="box">
  <h3>Difuntos</h3>
  <table>
    <thead>
      <tr>
        <th>Persona</th>
        <th>Notas</th>
        <th>Fecha alta</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for d_item in data.difuntos %}
      <tr>
        <td><a href="{{ url_for('cemetery.person_edit', person_id=d_item.person.id) }}">{{ d_item.person.full_name }}</a></td>
        <td>{{ d_item.notes or '-' }}</td>
        <td>{{ d_item.created_at.date() }}</td>
        <td>
          <form method="post" action="{{ url_for('cemetery.remove_deceased', sepultura_id=data.sepultura.id, sepultura_difunto_id=d_item.id) }}">
            <button class="btn" type="submit">Eliminar</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="4">Sin difuntos</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <form method="post" action="{{ url_for('cemetery.add_deceased', sepultura_id=data.sepultura.id) }}">
    {% with
      picker_id='difuntos-tab-' ~ data.sepultura.id,
      field_name='person_id',
      label='Difunto',
      selected_person=None,
      required=True
    %}
      {% include "components/person_picker.html" %}
    {% endwith %}
    <label>Notas</label>
    <input type="text" name="notes" placeholder="Observaciones de inhumaciÃ³n">
    <div class="actions-row">
      <button class="btn primary" type="submit">Registrar difunto</button>
    </div>
  </form>
</div>

{% elif data.tab == 'tasas' %}
<div class="box">
  <h3>{{ t('cem.fees') }}</h3>
  <table>
    <thead>
      <tr>
        <th>AÃ±o</th>
        <th>Importe</th>
        <th>Descuento</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody>
      {% for ticket in data.tasas %}
      <tr>
        <td>{{ ticket.anio }}</td>
        <td>{{ money(ticket.importe) }}</td>
        <td>{{ ticket.descuento_tipo.value }}</td>
        <td>{{ ticket.estado.value }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">Sin tiquets</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="actions-row">
    <a class="btn primary" href="{{ url_for('cemetery.fee_collection', sepultura_id=data.sepultura.id) }}">Ir a cobro de tasas</a>
  </div>
</div>
{% elif data.tab == 'derecho' %}
<div class="box">
  <h3>{{ t('cem.rights') }}</h3>
  {% if data.contrato %}
  <div class="meta-row">
    <div><strong>Tipo:</strong> {{ 'LLOGUER' if data.contrato.tipo.value == 'USO_INMEDIATO' else data.contrato.tipo.value }}</div>
    <div><strong>Inicio:</strong> {{ data.contrato.fecha_inicio }}</div>
    <div><strong>Fin:</strong> {{ data.contrato.fecha_fin }}</div>
    <div><strong>Importe anual base:</strong> {{ money(data.contrato.annual_fee_amount) }}</div>
    <div><strong>Legacy 99:</strong> {% if data.contrato.legacy_99_years %}Si{% else %}No{% endif %}</div>
  </div>
  <div class="meta-row">
    <div>
      <strong>Titular actual:</strong>
      {% if data.active_titular %}
      <a href="{{ url_for('cemetery.person_edit', person_id=data.active_titular.person.id) }}">{{ data.active_titular.person.full_name }}</a>
      {% else %}
      -
      {% endif %}
    </div>
    <div>
      <strong>Beneficiario actual:</strong>
      {% if data.active_beneficiario %}
      <a href="{{ url_for('cemetery.person_edit', person_id=data.active_beneficiario.person.id) }}">{{ data.active_beneficiario.person.full_name }}</a>
      {% else %}
      -
      {% endif %}
    </div>
  </div>
  <div class="quick-actions">
    <a class="btn primary" href="{{ url_for('cemetery.contract_title_pdf', contract_id=data.contrato.id) }}" target="_blank">{{ t('common.download') }} tÃ­tulo (PDF)</a>
    <a class="btn" href="{{ url_for('module_pending', slug='ampliacion-derecho') }}">AmpliaciÃ³n</a>
    <a class="btn" href="{{ url_for('module_pending', slug='prorroga-derecho') }}">PrÃ³rroga</a>
  </div>
  {% else %}
  <form method="post" action="{{ url_for('cemetery.contract_create', sepultura_id=data.sepultura.id) }}">
    <div class="form-grid">
      <div>
        <label>Tipo</label>
        <select name="tipo" required>
          <option value="CONCESION">CONCESION</option>
          <option value="USO_INMEDIATO">LLOGUER (USO_INMEDIATO)</option>
        </select>
      </div>
      <div>
        <label>Importe anual base</label>
        <input type="text" name="annual_fee_amount" placeholder="45.00" required>
      </div>
      <div>
        <label>Fecha inicio</label>
        <input type="date" name="fecha_inicio" required>
      </div>
      <div>
        <label>Fecha fin</label>
        <input type="date" name="fecha_fin" required>
      </div>
    </div>
    {% with
      picker_id='contract-titular-' ~ data.sepultura.id,
      field_name='titular_person_id',
      label='Titular',
      selected_person=None,
      required=True
    %}
      {% include "components/person_picker.html" %}
    {% endwith %}
    {% with
      picker_id='contract-beneficiario-' ~ data.sepultura.id,
      field_name='beneficiario_person_id',
      label='Beneficiario (opcional)',
      selected_person=None,
      required=False
    %}
      {% include "components/person_picker.html" %}
    {% endwith %}
    <div class="form-grid">
      <div>
        <label>
          <input type="checkbox" name="pensionista"> Titular pensionista
        </label>
      </div>
      <div>
        <label>Pensionista desde</label>
        <input type="date" name="pensionista_desde">
      </div>
      <div>
        <label>
          <input type="checkbox" name="legacy_99_years"> ConcesiÃ³n legacy (hasta 99 aÃ±os)
        </label>
      </div>
    </div>
    <div class="actions-row">
      <button class="btn primary" type="submit">Crear derecho funerario</button>
    </div>
  </form>
  {% endif %}
</div>
{% elif data.tab == 'notas' %}
<div class="box">
  <h3>Notas</h3>
  <form method="post" action="{{ url_for('cemetery.grave_notes_update', sepultura_id=data.sepultura.id) }}">
    <div class="form-grid">
      <div>
        <label>Post it</label>
        <input
          type="text"
          name="postit"
          maxlength="255"
          placeholder="Frase corta visible en principal"
          value="{{ data.sepultura.postit or '' }}"
        >
      </div>
    </div>
    <div>
      <label>Anotaciones</label>
      <textarea
        class="sepultura-notes-textarea"
        name="notas"
        rows="14"
        placeholder="Escribe aqui las anotaciones internas de la sepultura"
      >{{ data.sepultura.notas or '' }}</textarea>
    </div>
    <div class="actions-row">
      <button class="btn primary" type="submit">Guardar notas</button>
    </div>
  </form>
</div>
{% elif data.tab == 'lapidas' %}
<div class="box">
  <h3>{{ t('cem.engraving') }}</h3>
  <form class="inline-form" method="post" action="{{ url_for('cemetery.lapidas_create_inscripcion') }}">
    <input type="hidden" name="sepultura_id" value="{{ data.sepultura.id }}">
    <input type="text" name="texto" placeholder="Texto de inscripciÃ³n" required>
    <button class="btn" type="submit">Crear encargo de inscripciÃ³n</button>
  </form>
  <div class="actions-row">
    <a class="btn primary" href="{{ url_for('cemetery.lapidas', sepultura_id=data.sepultura.id) }}">Abrir mÃ³dulo de lÃ¡pidas</a>
  </div>
</div>
{% else %}
<div class="box">
  <h3>Movimientos</h3>
  <form method="get" action="{{ url_for('cemetery.grave_detail', sepultura_id=data.sepultura.id) }}">
    <input type="hidden" name="tab" value="movimientos">
    <div class="form-grid">
      <div>
        <label>Tipo</label>
        <select name="tipo">
          <option value="">Todos</option>
          <option value="INHUMACION">INHUMACION</option>
          <option value="EXHUMACION">EXHUMACION</option>
          <option value="TASAS">TASAS</option>
          <option value="LAPIDA">LAPIDA</option>
          <option value="CAMBIO_ESTADO">CAMBIO_ESTADO</option>
          <option value="CONTRATO">CONTRATO</option>
          <option value="INSCRIPCION_LATERAL">INSCRIPCION_LATERAL</option>
        </select>
      </div>
      <div>
        <label>Desde</label>
        <input type="date" name="desde" value="{{ request.args.get('desde', '') }}">
      </div>
      <div>
        <label>Hasta</label>
        <input type="date" name="hasta" value="{{ request.args.get('hasta', '') }}">
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button type="submit">Aplicar</button>
      </div>
    </div>
  </form>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Tipo</th>
        <th>Detalle</th>
        <th>Usuario</th>
      </tr>
    </thead>
    <tbody>
      {% for mov in data.movimientos %}
      <tr>
        <td>{{ mov.fecha.date() }}</td>
        <td>{{ mov.tipo.value }}</td>
        <td>{{ mov.detalle }}</td>
        <td>{{ mov.user.full_name if mov.user else 'sistema' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">{{ t('common.no_results') }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}
{% endblock %}

