{% extends "base.html" %}
{% set active_cem = 'expedientes' %}
{% set breadcrumbs = [
  {'label': t('menu.cemetery'), 'href': url_for('cemetery.panel')},
  {'label': t('cases.title'), 'href': None}
] %}
{% block title %}{{ t('cases.title') }}{% endblock %}
{% block content %}
<h1 class="page-title">{{ t('cases.title') }}</h1>
{% set create_tipo = request.args.get('create_tipo', 'INHUMACION').upper() %}

<div class="box">
  <h3>{{ t('cases.create_record') }}</h3>
  <form method="post" action="{{ url_for('cemetery.expedientes') }}">
    <div class="form-grid">
      <div>
        <label>{{ t('field.type') }}</label>
        <select name="tipo" required>
          <option value="INHUMACION" {% if create_tipo == 'INHUMACION' %}selected{% endif %}>{{ t('cases.inhumation') }}</option>
          <option value="EXHUMACION" {% if create_tipo == 'EXHUMACION' %}selected{% endif %}>{{ t('cases.exhumation') }}</option>
          <option value="RESCATE" {% if create_tipo == 'RESCATE' %}selected{% endif %}>{{ t('cases.rescue') }}</option>
          <option value="FINALIZACION" {% if create_tipo == 'FINALIZACION' %}selected{% endif %}>{{ t('cases.closure') }}</option>
        </select>
      </div>
      <div>
        <label>{{ t('cem.graves') }} (ID)</label>
        <input type="number" name="sepultura_id" value="{{ request.args.get('sepultura_id', '') }}">
      </div>
      <div>
        {% with
          picker_id='expediente-difunto-create',
          field_name='difunto_id',
          label=t('dashboard.deceased'),
          selected_person=None,
          required=False
        %}
          {% include "components/person_picker.html" %}
        {% endwith %}
      </div>
      <div>
        {% with
          picker_id='expediente-declarante-create',
          field_name='declarante_id',
          label=t('field.declarant'),
          selected_person=None,
          required=False
        %}
          {% include "components/person_picker.html" %}
        {% endwith %}
      </div>
      <div>
        <label>{{ t('field.expected_date') }}</label>
        <input type="date" name="fecha_prevista">
      </div>
      <div style="grid-column: 1 / -1;">
        <label>{{ t('field.notes') }}</label>
        <input type="text" name="notas" placeholder="{{ t('common.notes_placeholder_record') }}">
      </div>
    </div>
    <div class="actions-row">
      <button class="btn primary" type="submit">{{ t('cases.create_record') }}</button>
    </div>
  </form>
</div>

<div class="box">
  <h3>{{ t('common.filter') }}s</h3>
  <form method="get" action="{{ url_for('cemetery.expedientes') }}">
    <div class="form-grid">
      <div>
        <label>{{ t('field.type') }}</label>
        <input type="text" name="tipo" value="{{ filters.tipo }}">
      </div>
      <div>
        <label>{{ t('field.status') }}</label>
        <select name="estado">
          <option value="">{{ t('search.all') }}</option>
          {% for st in states %}
          <option value="{{ st }}" {% if filters.estado == st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>{{ t('field.from') }}</label>
        <input type="date" name="created_from" value="{{ filters.created_from }}">
      </div>
      <div>
        <label>{{ t('field.to') }}</label>
        <input type="date" name="created_to" value="{{ filters.created_to }}">
      </div>
      <div>
        <label>{{ t('cem.graves') }} ID</label>
        <input type="text" name="sepultura_id" value="{{ filters.sepultura_id }}">
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px;">
        <button class="btn" type="submit">{{ t('common.apply') }}</button>
        <a class="btn" href="{{ url_for('cemetery.expedientes') }}">{{ t('common.clear') }}</a>
      </div>
    </div>
  </form>
</div>

<div class="box">
  <h3>{{ t('cases.list') }}</h3>
  <table>
    <thead>
      <tr>
        <th>{{ t('common.id') }}</th>
        <th>{{ t('field.type') }}</th>
        <th>{{ t('field.status') }}</th>
        <th>{{ t('cem.graves') }}</th>
        <th>{{ t('field.deceased') }}</th>
        <th>{{ t('field.declarant') }}</th>
        <th>{{ t('cases.expected') }}</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
      <tr>
        <td>{{ row.numero }}</td>
        <td>{{ row.tipo }}</td>
        <td>{{ row.estado }}</td>
        <td>{{ row.sepultura_id or '-' }}</td>
        <td>{{ row.difunto.full_name if row.difunto else '-' }}</td>
        <td>{{ row.declarante.full_name if row.declarante else '-' }}</td>
        <td>{{ row.fecha_prevista or '-' }}</td>
        <td><a class="btn" href="{{ url_for('cemetery.expediente_detail', expediente_id=row.id) }}">{{ t('common.open') }}</a></td>
      </tr>
      {% else %}
      <tr><td colspan="8">{{ t('cases.none') }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
