{% extends "base.html" %}
{% set active_cem = 'titularidad' %}
{% block title %}Caso {{ data.case.case_number }}{% endblock %}
{% block content %}
<h1 class="page-title">Caso {{ data.case.case_number }}</h1>

<div class="box">
  <h3>Resumen</h3>
  <div class="meta-row">
    <div><strong>Tipo:</strong> {{ data.case.type.value }}</div>
    <div><strong>Estado:</strong> {{ data.case.status.value }}</div>
    <div><strong>Contrato:</strong> {{ data.contract.id }}</div>
    <div><strong>Sepultura:</strong> {{ data.sepultura.location_label }}</div>
    <div><strong>Abierto:</strong> {{ data.case.opened_at.date() }}</div>
    <div><strong>Asignado:</strong> {{ data.case.assigned_to.full_name if data.case.assigned_to else '-' }}</div>
  </div>
  <div class="meta-row">
    {% if data.case.resolution_number %}
    <div><strong>Resolucion:</strong> {{ data.case.resolution_number }}</div>
    <div><a class="btn" href="{{ url_for('cemetery.ownership_case_resolution_pdf_route', case_id=data.case.id) }}" target="_blank">Ver PDF</a></div>
    {% endif %}
    {% if data.case.type.value == 'PROVISIONAL' %}
    <div><strong>Inicio provisional:</strong> {{ data.case.provisional_start_date or '-' }}</div>
    <div><strong>Hasta:</strong> {{ data.case.provisional_until or '-' }}</div>
    {% endif %}
  </div>
</div>

<div class="box">
  <h3>Partes</h3>
  <table>
    <thead>
      <tr>
        <th>Rol</th>
        <th>Persona</th>
        <th>Documento</th>
        <th>%</th>
      </tr>
    </thead>
    <tbody>
      {% for party in data.case.parties %}
      <tr>
        <td>{{ party.role.value }}</td>
        <td>{{ party.person.full_name }}</td>
        <td>{{ party.person.document_id or '-' }}</td>
        <td>{{ party.percentage or '-' }}</td>
      </tr>
      {% else %}
      <tr><td colspan="4">Sin partes</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <form method="post" action="{{ url_for('cemetery.ownership_case_add_party', case_id=data.case.id) }}">
    <div class="form-grid">
      <div>
        <label>Rol</label>
        <select name="role" required>
          <option value="ANTERIOR_TITULAR">ANTERIOR_TITULAR</option>
          <option value="NUEVO_TITULAR">NUEVO_TITULAR</option>
          <option value="CAUSANT">CAUSANT</option>
          <option value="REPRESENTANTE">REPRESENTANTE</option>
          <option value="OTRO">OTRO</option>
        </select>
      </div>
      <div>
        <label>Nombre</label>
        <input type="text" name="first_name" required>
      </div>
      <div>
        <label>Apellidos</label>
        <input type="text" name="last_name">
      </div>
      <div>
        <label>Documento</label>
        <input type="text" name="document_id">
      </div>
      <div>
        <label>% (opcional)</label>
        <input type="text" name="percentage">
      </div>
    </div>
    <div class="actions-row">
      <button class="btn" type="submit">Guardar parte</button>
    </div>
  </form>
</div>

<div class="box">
  <h3>Documentacion</h3>
  <table>
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Oblig.</th>
        <th>Estado</th>
        <th>Fichero</th>
        <th>Subir</th>
        <th>Verificar</th>
      </tr>
    </thead>
    <tbody>
      {% for doc in data.case.documents %}
      <tr>
        <td>{{ doc.doc_type }}</td>
        <td>{% if doc.required %}Si{% else %}No{% endif %}</td>
        <td>{{ doc.status.value }}</td>
        <td>
          {% if doc.file_path %}
            <a class="btn" href="{{ url_for('cemetery.ownership_case_download_document', case_id=data.case.id, doc_id=doc.id) }}">Descargar</a>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          <form method="post" action="{{ url_for('cemetery.ownership_case_upload_document', case_id=data.case.id, doc_id=doc.id) }}" enctype="multipart/form-data">
            <input type="file" name="file" required>
            <button class="btn" type="submit">Subir</button>
          </form>
        </td>
        <td>
          <form class="inline-form" method="post" action="{{ url_for('cemetery.ownership_case_verify_document', case_id=data.case.id, doc_id=doc.id) }}">
            <input type="hidden" name="action" value="verify">
            <button class="btn" type="submit">OK</button>
          </form>
          <form class="inline-form" method="post" action="{{ url_for('cemetery.ownership_case_verify_document', case_id=data.case.id, doc_id=doc.id) }}">
            <input type="hidden" name="action" value="reject">
            <button class="btn" type="submit">Rechazar</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6">Sin checklist</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if data.case.type.value == 'PROVISIONAL' %}
<div class="box">
  <h3>Publicaciones</h3>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Canal</th>
        <th>Referencia</th>
      </tr>
    </thead>
    <tbody>
      {% for publication in data.case.publications %}
      <tr>
        <td>{{ publication.published_at }}</td>
        <td>{{ publication.channel }}</td>
        <td>{{ publication.reference_text }}</td>
      </tr>
      {% else %}
      <tr><td colspan="3">Sin publicaciones</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <form method="post" action="{{ url_for('cemetery.ownership_case_add_publication', case_id=data.case.id) }}">
    <div class="form-grid">
      <div>
        <label>Fecha</label>
        <input type="date" name="published_at" required>
      </div>
      <div>
        <label>Canal</label>
        <input type="text" name="channel" placeholder="BOP / DIARIO" required>
      </div>
      <div>
        <label>Referencia</label>
        <input type="text" name="reference_text">
      </div>
    </div>
    <div class="actions-row">
      <button class="btn" type="submit">Agregar publicacion</button>
    </div>
  </form>
</div>
{% endif %}

<div class="box">
  <h3>Acciones</h3>
  <div class="quick-actions">
    <form class="inline-form" method="post" action="{{ url_for('cemetery.ownership_case_change_status', case_id=data.case.id) }}">
      <select name="status">
        {% for status in OwnershipTransferStatus %}
        <option value="{{ status.value }}">{{ status.value }}</option>
        {% endfor %}
      </select>
      <button class="btn" type="submit">Cambiar estado</button>
    </form>
    <form class="inline-form" method="post" action="{{ url_for('cemetery.ownership_case_approve', case_id=data.case.id) }}">
      <button class="btn" type="submit">Aprobar</button>
    </form>
    <form class="inline-form" method="post" action="{{ url_for('cemetery.ownership_case_reject', case_id=data.case.id) }}">
      <input type="text" name="reason" placeholder="Motivo rechazo" required>
      <button class="btn" type="submit">Rechazar</button>
    </form>
  </div>
  <h4>Cerrar caso</h4>
  <form method="post" action="{{ url_for('cemetery.ownership_case_close', case_id=data.case.id) }}">
    <div class="form-grid">
      <div>
        <label>
          <input type="checkbox" name="is_pensioner"> Nuevo titular pensionista
        </label>
      </div>
      <div>
        <label>Pensionista desde</label>
        <input type="date" name="pensioner_since_date">
      </div>
      <div>
        <label>Beneficiario actual</label>
        <input type="text" value="{{ data.active_beneficiary.person.full_name if data.active_beneficiary else '-' }}" disabled>
      </div>
      <div>
        <label>Decision beneficiario</label>
        <select name="beneficiary_close_decision">
          <option value="">(si aplica)</option>
          <option value="KEEP">Mantener</option>
          <option value="REPLACE">Sustituir</option>
        </select>
      </div>
      <div>
        <label>Nuevo beneficiario nombre</label>
        <input type="text" name="beneficiary_first_name">
      </div>
      <div>
        <label>Nuevo beneficiario apellidos</label>
        <input type="text" name="beneficiary_last_name">
      </div>
      <div>
        <label>Nuevo beneficiario documento</label>
        <input type="text" name="beneficiary_document_id">
      </div>
    </div>
    <div class="actions-row">
      <button class="btn primary" type="submit">Cerrar caso</button>
    </div>
  </form>
</div>
{% endblock %}
