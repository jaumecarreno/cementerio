{% extends "base.html" %}
{% set active_cem = 'reporting' %}
{% set breadcrumbs = [
  {'label': t('menu.dashboard'), 'href': url_for('cemetery.panel')},
  {'label': t('reporting.title'), 'href': None}
] %}
{% block title %}{{ t('reporting.title') }}{% endblock %}
{% block content %}
<h1 class="page-title">{{ t('reporting.title') }}</h1>

<div class="box">
  <h3>{{ t('reporting.report_and_filters') }}</h3>
  <form method="get" action="{{ url_for('cemetery.reporting') }}">
    <div class="form-grid">
      <div>
        <label>{{ t('reporting.report_type') }}</label>
        <select name="report">
          <option value="sepulturas" {% if report_key == 'sepulturas' %}selected{% endif %}>{{ t('reporting.graves') }}</option>
          <option value="contratos" {% if report_key == 'contratos' %}selected{% endif %}>{{ t('reporting.contracts') }}</option>
          <option value="deuda" {% if report_key == 'deuda' %}selected{% endif %}>{{ t('reporting.debt') }}</option>
        </select>
      </div>
      <div>
        <label>{{ t('reporting.grave_state') }}</label>
        <input type="text" name="estado" value="{{ filters.estado }}">
      </div>
      <div>
        <label>{{ t('reporting.modality') }}</label>
        <input type="text" name="modalidad" value="{{ filters.modalidad }}">
      </div>
      <div>
        <label>{{ t('reporting.block') }}</label>
        <input type="text" name="bloque" value="{{ filters.bloque }}">
      </div>
      <div>
        <label>{{ t('reporting.contract_type') }}</label>
        <input type="text" name="tipo" value="{{ filters.tipo }}">
      </div>
      <div>
        <label>{{ t('reporting.contract_validity') }}</label>
        <select name="vigencia">
          <option value="" {% if not filters.vigencia %}selected{% endif %}>{{ t('reporting.all') }}</option>
          <option value="VIGENTE" {% if filters.vigencia == 'VIGENTE' %}selected{% endif %}>{{ t('reporting.active') }}</option>
          <option value="VENCIDO" {% if filters.vigencia == 'VENCIDO' %}selected{% endif %}>{{ t('reporting.expired') }}</option>
        </select>
      </div>
      <div>
        <label>{{ t('reporting.holder') }}</label>
        <input type="text" name="titular" value="{{ filters.titular }}">
      </div>
      <div>
        <label>{{ t('reporting.contract_id_debt') }}</label>
        <input type="text" name="contrato_id" value="{{ filters.contrato_id }}">
      </div>
      <div>
        <label>{{ t('reporting.page_size') }}</label>
        <input type="number" name="page_size" value="{{ paged.page_size }}" min="1" max="100">
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px;">
        <button class="btn" type="submit">{{ t('common.apply') }}</button>
        <a class="btn" href="{{ url_for('cemetery.reporting') }}">{{ t('common.clear') }}</a>
      </div>
    </div>
  </form>
  <div class="actions-row">
    <a class="btn primary" href="{{ url_for('cemetery.reporting_export_csv', report=report_key, estado=filters.estado, modalidad=filters.modalidad, bloque=filters.bloque, tipo=filters.tipo, vigencia=filters.vigencia, titular=filters.titular, contrato_id=filters.contrato_id) }}">{{ t('reporting.export_csv') }}</a>
  </div>
</div>

<div class="box">
  <h3>{{ t('reporting.results') }}</h3>
  <div class="meta-row">
    <div><strong>{{ t('common.total') }}:</strong> {{ paged.total }}</div>
    <div><strong>{{ t('common.page') }}:</strong> {{ paged.page }} / {{ paged.pages }}</div>
  </div>
  <table>
    <thead>
      {% if report_key == 'sepulturas' %}
      <tr><th>{{ t('common.id') }}</th><th>{{ t('reporting.graves') }}</th><th>{{ t('reporting.block') }}</th><th>{{ t('reporting.modality') }}</th><th>{{ t('dashboard.state') }}</th></tr>
      {% elif report_key == 'contratos' %}
      <tr><th>{{ t('common.id') }}</th><th>{{ t('reporting.contract_type') }}</th><th>{{ t('reporting.contract_validity') }}</th><th>{{ t('reporting.holder') }}</th><th>{{ t('reporting.graves') }}</th></tr>
      {% else %}
      <tr><th>{{ t('reporting.contracts') }}</th><th>{{ t('reporting.graves') }}</th><th>{{ t('reporting.pending_tickets') }}</th><th>{{ t('reporting.tickets_amount') }}</th><th>{{ t('reporting.unpaid_invoices') }}</th><th>{{ t('reporting.invoices_amount') }}</th><th>{{ t('reporting.total_debt') }}</th></tr>
      {% endif %}
    </thead>
    <tbody>
      {% for row in paged.rows %}
      {% if report_key == 'sepulturas' %}
      <tr>
        <td>{{ row.id }}</td>
        <td>{{ row.sepultura }}</td>
        <td>{{ row.bloque }}</td>
        <td>{{ row.modalidad }}</td>
        <td>{{ row.estado }}</td>
      </tr>
      {% elif report_key == 'contratos' %}
      <tr>
        <td>{{ row.id }}</td>
        <td>{{ row.tipo }}</td>
        <td>{{ row.vigencia }}</td>
        <td>{{ row.titular }}</td>
        <td>{{ row.sepultura }}</td>
      </tr>
      {% else %}
      <tr>
        <td>{{ row.contrato_id }}</td>
        <td>{{ row.sepultura }}</td>
        <td>{{ row.tickets_pendientes }}</td>
        <td>{{ money(row.importe_tickets) }}</td>
        <td>{{ row.facturas_impagadas }}</td>
        <td>{{ money(row.importe_facturas) }}</td>
        <td>{{ money(row.deuda_total) }}</td>
      </tr>
      {% endif %}
      {% else %}
      <tr><td colspan="7">{{ t('common.no_results') }}</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="quick-actions">
    {% if paged.page > 1 %}
    <a class="btn" href="{{ url_for('cemetery.reporting', report=report_key, page=paged.page-1, page_size=paged.page_size, estado=filters.estado, modalidad=filters.modalidad, bloque=filters.bloque, tipo=filters.tipo, vigencia=filters.vigencia, titular=filters.titular, contrato_id=filters.contrato_id) }}">{{ t('common.previous') }}</a>
    {% endif %}
    {% if paged.page < paged.pages %}
    <a class="btn" href="{{ url_for('cemetery.reporting', report=report_key, page=paged.page+1, page_size=paged.page_size, estado=filters.estado, modalidad=filters.modalidad, bloque=filters.bloque, tipo=filters.tipo, vigencia=filters.vigencia, titular=filters.titular, contrato_id=filters.contrato_id) }}">{{ t('common.next') }}</a>
    {% endif %}
  </div>
</div>
{% endblock %}
