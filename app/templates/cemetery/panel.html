<!-- Spec 9.0 + mockups_v2/page-2 - Panel de trabajo Cementerio -->
{% extends "base.html" %}
{% set active_global = 'cemetery' %}
{% set active_cem = 'panel' %}
{% block title %}{{ t('menu.cemetery') }}{% endblock %}
{% block content %}
<h1 class="page-title">{{ t('menu.cemetery') }}</h1>

<div class="box">
  <div class="dashboard-top-actions">
    <a class="btn primary" href="{{ url_for('cemetery.expedientes', create_tipo='INHUMACION') }}">{{ t('action.new_inhumation') }}</a>
    <a class="btn primary" href="{{ url_for('cemetery.expedientes', create_tipo='EXHUMACION') }}">{{ t('action.new_exhumation') }}</a>
    <a class="btn" href="{{ url_for('cemetery.search_graves') }}">{{ t('common.search') }}</a>
  </div>
  <h3>{{ t('dashboard.recent_activity') }}</h3>
  {% if data.recent_activity_by_titular %}
  <div class="activity-groups">
    {% for group in data.recent_activity_by_titular %}
    <div class="activity-group">
      <h4>{{ group.titular }}</h4>
      <table>
        <thead>
          <tr>
            <th>{{ t('dashboard.date') }}</th>
            <th>{{ t('dashboard.change') }}</th>
            <th>{{ t('cem.graves') }}</th>
            <th>{{ t('dashboard.detail') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for item in group.movements %}
          <tr>
            <td>{{ item.fecha.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>{{ item.tipo }}</td>
            <td>{{ item.sepultura }}</td>
            <td>{{ item.detalle }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="muted">{{ t('dashboard.no_recent_activity') }}</p>
  {% endif %}
</div>

<div class="cards">
  <div class="card">
    <h4>{{ t('dashboard.open_cases') }}</h4>
    <div class="num">{{ data.kpis.expedientes_abiertos }}</div>
  </div>
  <div class="card">
    <h4>{{ t('dashboard.pending_work_orders') }}</h4>
    <div class="num">{{ data.kpis.ot_pendientes }}</div>
  </div>
  <div class="card">
    <h4>{{ t('dashboard.unpaid_tickets') }}</h4>
    <div class="num">{{ data.kpis.tiquets_impagados }}</div>
  </div>
  <div class="card">
    <h4>{{ t('dashboard.pending_notify') }}</h4>
    <div class="num">{{ data.kpis.pendientes_notificar }}</div>
  </div>
</div>

<div class="panel-grid">
  <div class="box">
    <h3>{{ t('dashboard.recent_cases') }}</h3>
    <table>
      <thead>
        <tr>
          <th>{{ t('dashboard.case_number') }}</th>
          <th>{{ t('reporting.contract_type') }}</th>
          <th>{{ t('dashboard.deceased') }}</th>
          <th>{{ t('dashboard.state') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for expediente, person in data.recent_expedientes %}
        <tr>
          <td>{{ expediente.numero }}</td>
          <td>{{ expediente.tipo }}</td>
          <td>{{ person.full_name if person else '-' }}</td>
          <td>{{ expediente.estado }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="box">
    <h3>{{ t('dashboard.alerts') }}</h3>
    <ul>
      {% for alert in data.alerts %}
      <li>{{ alert }}</li>
      {% endfor %}
    </ul>
  </div>
</div>

<div class="box">
  <h3>{{ t('dashboard.quick_actions') }}</h3>
  <div class="quick-actions">
    <a class="btn" href="{{ url_for('cemetery.search_graves') }}?redirect=fees">{{ t('action.collect_fees') }}</a>
    <a class="btn" href="{{ url_for('cemetery.ownership_cases') }}">{{ t('cem.ownership') }}</a>
    <a class="btn" href="{{ url_for('cemetery.mass_create') }}">{{ t('action.mass_create') }}</a>
    {% if g.membership and g.membership.role == "admin" %}
    <form class="inline-form" method="post" action="{{ url_for('cemetery.admin_generate_tickets') }}">
      <input type="number" name="year" min="2000" max="2100" value="{{ current_year }}" style="width: 130px;">
      <button class="btn" type="submit">{{ t('action.generate_yearly_tickets') }}</button>
    </form>
    {% endif %}
  </div>
</div>
{% endblock %}
