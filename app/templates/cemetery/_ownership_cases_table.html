<div class="box">
  <table>
    <thead>
      <tr>
        <th>No caso</th>
        <th>Tipo</th>
        <th>Estado</th>
        <th>Contrato/Sepultura</th>
        <th>Titular ant. -> nuevo</th>
        <th>Abierto</th>
        <th>Asignado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for case in rows %}
      {% set ns = namespace(prev='-', new='-') %}
      {% for party in case.parties %}
        {% if party.role.value in ['CAUSANT', 'ANTERIOR_TITULAR'] %}
          {% set ns.prev = party.person.full_name %}
        {% endif %}
        {% if party.role.value == 'NUEVO_TITULAR' %}
          {% set ns.new = party.person.full_name %}
        {% endif %}
      {% endfor %}
      <tr>
        <td>{{ case.case_number }}</td>
        <td>{{ case.type.value }}</td>
        <td>{{ case.status.value }}</td>
        <td>
          C{{ case.contract_id }}
          {% if case.contract and case.contract.sepultura %}
          / {{ case.contract.sepultura.location_label }}
          {% endif %}
        </td>
        <td>{{ ns.prev }} -> {{ ns.new }}</td>
        <td>{{ case.opened_at.date() }}</td>
        <td>{{ case.assigned_to.full_name if case.assigned_to else '-' }}</td>
        <td>
          <a class="btn" href="{{ url_for('cemetery.ownership_case_detail_page', case_id=case.id) }}">Abrir</a>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="8">Sin casos</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
